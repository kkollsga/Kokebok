<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Mine Oppskrifter - Hjemmelaget og Koselig</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .font-display {
            font-family: 'Playfair Display', serif;
        }
        .recipe-card {
            transition: all 0.3s ease;
        }
        .recipe-card:hover {
            transform: translateY(-4px);
        }
        .star {
            transition: all 0.2s ease;
        }
        .star:hover {
            transform: scale(1.2);
        }
        button svg {
            transition: transform 0.2s ease;
        }
        button:active svg {
            transform: scale(0.9);
        }
        /* Filter animations */
        #filterPillsContainer {
            transition: max-width 0.3s ease-out, opacity 0.3s ease-out;
            white-space: nowrap;
            overflow: hidden;
        }
        .filter-pill {
            max-width: 150px;
            display: inline-flex !important;
        }
        .filter-pill-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 120px;
        }
        #filterToggle {
            transition: all 0.2s ease;
        }
        #clearFilters {
            transition: opacity 0.2s ease;
        }
        /* Checkbox styling */
        input[type="checkbox"] {
            cursor: pointer;
        }
        input[type="checkbox"]:checked {
            background-color: rgb(217 119 6);
            border-color: rgb(217 119 6);
        }
        /* Custom scrollbar for recipe sections */
        .recipe-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .recipe-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        .recipe-scroll::-webkit-scrollbar-thumb {
            background: #d4d4d4;
            border-radius: 3px;
        }
        .recipe-scroll::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        /* Body lock when modal is open */
        body.modal-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
        }
        /* Mobile modal styles with Safari support */
        @supports (height: 100dvh) {
            .modal-height-mobile {
                height: 100dvh !important;
            }
        }
        @supports not (height: 100dvh) {
            .modal-height-mobile {
                height: 100vh !important;
                height: -webkit-fill-available !important;
            }
        }
        @media (max-width: 640px) {
            #recipeModal {
                padding: 0 !important;
            }
            .modal-content-mobile {
                height: 100vh;
                height: 100dvh;
                height: -webkit-fill-available;
                width: 100vw !important;
                max-width: 100vw !important;
                border-radius: 0 !important;
                margin: 0 !important;
            }
            .modal-scroll-mobile {
                overflow-y: auto !important;
                max-height: none !important;
                padding-bottom: calc(env(safe-area-inset-bottom, 20px) + 40px);
            }
            .modal-close-mobile {
                position: fixed !important;
                top: 16px !important;
                right: 16px !important;
                z-index: 50 !important;
            }
        }
        /* Modern input focus styles */
        .modern-input:focus {
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
        }
        /* Filter menu shadow */
        .filter-menu-shadow {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        /* Safe area padding for iOS */
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom, 0);
        }
        .safe-top {
            padding-top: env(safe-area-inset-top, 0);
        }
        /* Category badge hover effect */
        .category-badge {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .category-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-orange-50 via-amber-50 to-yellow-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white/90 backdrop-blur-sm shadow-sm sticky top-0 z-40 safe-top">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <h1 class="font-display text-3xl text-amber-800">Mine Oppskrifter</h1>
            </div>
        </div>
    </header>

    <!-- Search Bar -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
        <div class="bg-white/95 backdrop-blur rounded-2xl shadow-lg border border-white/50 p-1.5">
            <div class="relative">
                <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <input type="text" id="searchInput" placeholder="Søk etter oppskrifter eller ingredienser..." 
                       class="modern-input w-full pl-12 pr-4 py-3 bg-gray-50/50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-amber-400 focus:bg-white transition-all text-gray-700 placeholder-gray-400">
            </div>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-4">
        <div class="bg-white/95 backdrop-blur rounded-2xl shadow-lg border border-white/50 p-4">
            <div class="flex items-center gap-3">
                <!-- Filter Button -->
                <button id="filterToggle" onclick="toggleFilterMenu()" 
                        class="flex items-center space-x-2 px-4 py-2 rounded-xl transition-all text-sm font-medium shrink-0 shadow-sm hover:shadow-md">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                    </svg>
                    <span>Filter</span>
                    <span id="filterCount" class="hidden bg-white/30 text-white text-xs px-1.5 py-0.5 rounded-full font-semibold">0</span>
                </button>
                
                <!-- Filter Pills Container -->
                <div id="filterPillsContainer" class="flex gap-2 flex-1 overflow-hidden">
                    <!-- Filter pills will be inserted here -->
                </div>
            </div>
        </div>
        
        <!-- Clear Filters Button (moved below) -->
        <div class="flex justify-end mt-2">
            <button id="clearFilters" onclick="clearAllFilters()" 
                    class="text-xs text-gray-500 hover:text-amber-600 transition-all opacity-0 pointer-events-none font-medium px-3 py-1 rounded-lg hover:bg-white/80">
                Tøm filter
            </button>
        </div>
        
        <!-- Filter Dropdown Menu -->
        <div id="filterMenu" class="relative">
            <div class="absolute top-2 left-0 bg-white rounded-xl filter-menu-shadow border border-gray-100 p-4 z-30 hidden min-w-[280px]">
                <div class="text-sm font-semibold text-gray-700 mb-3">Velg kategorier</div>
                <div id="filterOptions" class="space-y-1 max-h-96 overflow-y-auto">
                    <!-- Filter options will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Recommendations Section -->
    <div id="recommendationsSection" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">
        <div id="recommendations" class="mb-8">
            <h2 class="font-display text-2xl text-amber-800 mb-4">Anbefalte for deg</h2>
            <div id="recommendedRecipes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Recommended recipes will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Main Recipe Grid -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8 pb-12 safe-bottom">
        <h2 class="font-display text-2xl text-amber-800 mb-4">Alle Oppskrifter</h2>
        <div id="recipeGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Recipe cards will be inserted here -->
        </div>
    </div>

    <!-- Recipe Modal -->
    <div id="recipeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen sm:p-4">
            <div class="bg-white sm:rounded-2xl max-w-4xl w-full sm:h-[90vh] modal-height-mobile flex flex-col overflow-hidden modal-content-mobile">
                <div id="modalContent" class="h-full flex flex-col">
                    <!-- Recipe content will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Filter state
        let activeFilters = new Map();
        let filterMenuOpen = false;
        let searchQuery = '';
        let scrollPosition = 0;
        
        // Recipe database - NOW AS AN ARRAY
        const recipeDatabase = [
            {"id":"recipe_1755475274682_pg1vg0qjn","title":"Kake med mokkakrem","servings":"10-12 porsjoner","provider":"Farmor","reference":"oppskriftsbok, side 5","category":"Kake","meal":"Dessert","cuisine":"Norsk","description":"En klassisk, luftig sukkerbrødkake fylt og dekket med en silkemyk mokkakrem. Kaken har en balansert smak av kaffe og kakao, og passer perfekt til kaffeselskap, bursdag eller fest. Kan også varieres med syltetøy mellom lagene for ekstra friskhet.","image":"https://unsplash.com/photos/a-cake-with-white-frosting-and-lit-candles--E3CGV9kfkU","ingredients":[{"group":"Sukkerbrød","items":["6 egg","180 g sukker (ca. 2 dl)","180 g hvetemel (ca. 3 dl)","1 ts bakepulver (valgfritt, gir ekstra sikkerhet)"]},{"group":"Mokkakrem","items":["150 g smør, romtemperert","100 g melis (ca. 1,5 dl)","3 ss sterk kaffe, avkjølt","2 ss kakao","1 ts vaniljedråper eller 1 ts vaniljesukker"]}],"instructions":["Sett ovnen på 160–170 °C (over- og undervarme). Smør en rundform (24 cm) og legg bakepapir i bunnen.","Visp egg og sukker til lys og luftig eggedosis (5–10 minutter).","Sikt mel og bakepulver over eggedosisen, og vend det forsiktig inn med en slikkepott.","Hell røren i formen og stek på nederste rille i ca. 30–40 minutter, til sukkerbrødet er gyllent og en kakepinne kommer ut ren. Avkjøl helt på rist.","Når sukkerbrødet er avkjølt, del det i to eller tre lag.","Lag mokkakremen: Pisk smør og melis hvitt og luftig (5–7 minutter). Tilsett kaffe, kakao og vanilje litt etter litt. Pisk til en jevn og smørbar krem.","Legg en kakebunn på fat. Smør på et lag mokkakrem, eller ha syltetøy mellom lagene om ønskelig. Fortsett med neste bunn.","Dekk hele kaken med resten av mokkakremen på toppen og langs sidene.","Pynt gjerne med mokkabønner, sjokoladespon eller et lett dryss kakao.","La kaken stå kjølig i minst 1 time før servering for at smakene skal sette seg."],"createdAt":"2025-08-18"},
            {"id":"recipe_1755476864587_2erpf8ln7","title":"Wienerbrød","servings":"Ca. 16–20 stk.","provider":"Farmor","reference":"Håndskrevet oppskriftsbok, side 13–14","category":"Bakverk","meal":"Dessert","cuisine":"Dansk","description":"Et klassisk dansk wienerbrød laget av en luftig gjærdeig som lamineres med margarin. Kaken kan fylles med forskjellige fyll – mandelmasse, eggekrem eller havregrynsfyll – og toppes med glasur. Resultatet er et luftig og smørfylt bakverk som passer perfekt til kaffebordet.","image":"https://images.unsplash.com/photo-1608198093002-ad4e005484c2?w=800&h=600&fit=crop","ingredients":[{"group":"Grunndeig","items":["500 g hvetemel","30 g sukker","50 g margarin (til deigen)","35 g gjær","1/2 ts kardemomme","3 dl melk","1 egg","150 g margarin (til innbaking, lagvis)"]},{"group":"Alternativ 1 – Mandelmassefyll","items":["50 g mandler (malte)","75 g sukker","1/2 eggehvite","3 ss mandeldråper"]},{"group":"Alternativ 2 – Havregrynsfyll","items":["50 g havregryn","75 g sukker","1/2 eggehvite","noen dråper vanilje eller mandelessens"]},{"group":"Alternativ 3 – Eggekremfyll","items":["20 g hvetemel","2 dl melk","1 eggeplomme","20 g sukker"]},{"group":"Melisglasur (valgfritt)","items":["75 g melis","1/2 eggehvite"]}],"instructions":["Lag deigen (Grunndeig): Bland mel og sukker i en bolle. Smuldre inn 50 g margarin.","Rør ut gjæren i lunken melk og tilsett sammen med egg og kardemomme. Elt deigen godt til den er smidig.","La deigen hvile i ca. 15 minutter. Kjevle deretter ut til et rektangel.","Fordel 150 g margarin i tynne skiver/klatter over deigen. Brett sammen og kjevle ut igjen. Gjenta 2–3 ganger for å få lagvis deig. La hvile mellom kjevlingene.","Velg fyll: Forbered ett av alternativene:","Alternativ 1 – Mandelmassefyll: Bland malte mandler, sukker, eggehvite og mandeldråper til en fast masse.","Alternativ 2 – Havregrynsfyll: Bland havregryn, sukker, eggehvite og noen dråper essens til en jevn masse.","Alternativ 3 – Eggekremfyll: Ha mel i en kjele, spe med melk og kok opp under omrøring. Tilsett sukker og eggeplomme. Rør til kremen tykner. Avkjøl.","Montering: Kjevle deigen ut til ca. 0,5 cm tykkelse. Skjær i firkanter, legg litt av valgt fyll i midten og brett hjørnene inn mot midten.","Legg brødene på bakepapirkledd stekebrett, dekk til og etterhev i 30–40 minutter.","Pensle med sammenvispet egg. Stek midt i ovnen ved 200 °C i ca. 10–12 minutter, til de er gyllenbrune.","Avkjøl på rist.","Glasur (Melisglasur, valgfritt): Bland melis og eggehvite til en glatt glasur. Ha den over de avkjølte vinabrødene.","Server nybakte eller oppbevar kjølig. Kan fryses uten glasur."],"createdAt":"2025-08-18"},
            {"id":"recipe_1755477197309_jcux6iyx1","title":"Formkake","servings":"8–10 porsjoner","provider":"Farmor","reference":"Håndskrevet oppskriftsbok, side 15","category":"Kake","meal":"Dessert","cuisine":"Skandinavisk","description":"En klassisk formkake med smør, sukker, egg og hvetemel, smaksatt med sitron og fylt med tørket frukt. Kaken blir saftig og aromatisk, perfekt til ettermiddagskaffen eller som en tradisjonell kaffekake. Sukat, som er kandisert sitron- eller appelsinskall, gir kaken en frisk og søt smak. Dersom du ikke finner sukat, kan du bruke kandisert appelsinskall, sitronskall eller erstatte med litt ekstra rosiner.","image":"https://images.unsplash.com/photo-1601979039455-2339bcaef9a9?w=800&h=600&fit=crop","ingredients":["100 g smør","100 g sukker","2 egg","200 g hvetemel","1 ts bakepulver","50 g korinter","50 g sukat","revet skall av 1/2 sitron eller 5–6 dråper sitronessens"],"instructions":["Visp smør og sukker hvitt og luftig.","Tilsett eggene, ett om gangen, og pisk godt mellom hver.","Sikt inn hvetemel og bakepulver, og vend forsiktig inn i røren.","Tilsett revet sitronskall eller sitrondråper.","Vend inn korinter og sukat til slutt.","Ha røren i en smurt form.","Stek i middels varm ovn (ca. 175–180 °C) i 35–45 minutter, til kaken er gjennomstekt og gyllen. Test med kakepinne.","Avkjøl på rist og server som den er eller med et lett dryss melis."],"createdAt":"2025-08-18"},
            {"id":"recipe_1755483218975_n2vin9hoz","title":"Peppernøtter","servings":"Ca. 40–50 småkaker","provider":"Farmor","reference":"Håndskrevet oppskriftsbok, side 16","category":"Julekaker","meal":"Snacks","cuisine":"Skandinavisk","description":"Peppernøtter er små krydrede julekaker som minner om pepperkaker, men de er rundere og litt mykere i konsistensen. De formes til små kuler og stekes til de blir gyllenbrune. Perfekte til adventstiden, julekaffen eller som små munnfuller gjennom hele desember.","image":"https://images.unsplash.com/photo-1607082349566-187342175e2f?w=800&h=600&fit=crop","ingredients":["125 g smør","125 g sukker","ca. 250 g hvetemel","1 dl kremfløte","1 ts kardemomme","1 ts kanel","1/3 ts pepper","1 ts natron","1/2 ts bakepulver"],"instructions":["Visp smør og sukker til det er hvitt og luftig.","Tilsett kremfløten og rør godt sammen.","Sikt hvetemel, kardemomme, kanel, pepper, natron og bakepulver i en bolle.","Vend det tørre inn i smørblandingen og arbeid deigen raskt sammen til en jevn deig.","Trill deigen til små kuler og legg dem på et bakepapirkledd stekebrett.","Stek peppernøttene midt i ovnen ved 175–180 °C i 8–10 minutter, til de er jevnt gyllenbrune.","Avkjøl på rist og oppbevar i en tett kakeboks."],"createdAt":"2025-08-18"},
            {"id":"recipe_1755484726501_29ubmpget","title":"Rundstykker","servings":"ca. 16 rundstykker","provider":"Farmor","category":"Brød","meal":"Frokost","cuisine":"Norsk","description":"Klassiske luftige rundstykker som passer perfekt til frokost, lunsj eller kveldsmat. Deigen er enkel å lage, og med både melk og smør får du myke rundstykker med god smak. De er like gode nystekte som oppvarmet, og egner seg også godt til frysing.","image":"https://unsplash.com/photos/a-wooden-cutting-board-topped-with-rolls-on-top-of-a-table-mSJCk6k2WtE","ingredients":["500 g hvetemel","1 pose tørrgjær (ca. 11 g)","50 g smør (romtemperert eller smeltet)","1 ½ ts salt","2 dl melk (lunken, ca. 37–40 °C)","1 ½ dl vann (lunkent, ca. 37–40 °C)","1 ss sukker"],"instructions":["Bland sammen hvetemel, tørrgjær, salt og sukker i en stor bolle.","Varm melk og vann til ca. 37–40 °C. Ha dette i melblandingen sammen med smøret.","Elt deigen i kjøkkenmaskin i 8–10 minutter (eller 12–15 minutter for hånd) til den er smidig og slipper bollen.","Dekk bollen med plast eller klede og la deigen heve på et lunt sted i ca. 1 time, til den har blitt dobbelt så stor.","Del deigen i ca. 16 emner og trill til runde boller. Legg dem på et stekebrett med bakepapir.","Etterhev rundstykkene i 30–40 minutter under klede.","Forvarm ovnen til 220 °C over-/undervarme. Stek rundstykkene midt i ovnen i 10–12 minutter til de er gylne og gjennomstekte.","Avkjøl på rist før servering."],"createdAt":"2025-08-18"},
            {"id":"recipe_1755485212305_6c4rynvqc","title":"Berlinerkranser","servings":"Ca. 30–40 stk.","provider":"Familiens kokebok","reference":"Håndskrevet oppskriftsbok, side 3","category":"Julekaker","meal":"Snacks","cuisine":"Norsk","description":"Berlinerkranser er en klassisk norsk julekake laget av en smør- og eggeplommerik deig. De formes til små kranser, pensles med eggehvite, dyppes i sukker og stekes til de er lett gylne. De har en sprø, søt overflate og en smørmør kjerne – en fast tradisjon på norske kakefat i julen.","image":"https://images.unsplash.com/photo-1607522370275-f14206abe5d3?w=800&h=600&fit=crop","ingredients":["250 g hvetemel","65 g sukker","145 g margarin eller smør","1 eggeplomme","1 eggehvite (til pensling)","perlesukker eller grovt sukker (til topping)"],"instructions":["Smuldre sammen hvetemel, sukker og margarin til en smuldrete blanding.","Tilsett eggeplommen og kna deigen godt sammen til en smidig deig.","Del deigen i små emner og trill ut til fingertykke pølser.","Form små kranser og legg på et bakepapirkledd stekebrett.","Pensle kransene med lett pisket eggehvite.","Dypp oversiden i perlesukker eller grovt sukker.","Stek ved svak varme, ca. 175 °C, i 8–10 minutter til de er lett gylne.","Avkjøl på rist og oppbevar i tett kakeboks."],"createdAt":"2025-08-18"},
            {"id":"recipe_1755523615872_c8ydauis7","title":"Sjokoladekake","servings":"10–12 porsjoner","provider":"Farmor","reference":"Håndskrevet oppskriftsbok, side 6","category":"Kake","meal":"Dessert","cuisine":"Skandinavisk","description":"En saftig sjokoladekake med en luftig bunn, fylt og dekket med en smørkrem laget på en base av vaniljekrem. Først kokes en enkel vaniljekrem som må avkjøles, deretter blandes den med smør og melis til en silkemyk smørkrem som både kan brukes som fyll mellom lagene og som glasur på toppen og sidene. Kaken pyntes til slutt med sjokolade, enten raspet som dekor eller smeltet og fordelt over glasuren for en blank finish.","image":"https://images.unsplash.com/photo-1606036905746-092ee6b6d5cb?w=800&h=600&fit=crop","ingredients":[{"group":"Kakebunn","items":["5 egg","150 g sukker","100 g hvetemel","50 g potetmel","25 g kakao","2 ts bakepulver (strøkne)","50 g revet sjokolade"]},{"group":"Glasur (smørkrem)","items":["1 1/2 ss hvetemel","1/2 liter melk","60–80 g sukker","1 egg","1–2 ts vaniljesukker","100 g smør","30–40 g melis"]},{"group":"Pynt","items":["100 g sjokolade (revet som spon eller smeltet til glasur)"]}],"instructions":["Pisk eggeplommene godt og tilsett sukkeret litt etter litt under stadig pisking.","Pisk eggehvitene stive og vend forsiktig inn i eggeplommeblandingen.","Bland hvetemel, potetmel, kakao, bakepulver og revet sjokolade. Sikt det tørre inn i røren og vend forsiktig sammen.","Hell røren i en smurt form (24 cm) og stek ved 175 °C i ca. 30–35 minutter, til kaken er gjennomstekt. Avkjøl helt.","Lag vaniljekrem (base til glasuren): Rør sammen hvetemel, melk og sukker i en kjele. Kok opp under omrøring. Tilsett vaniljesukker og egg, og rør til kremen tykner. Avkjøl helt.","Visp smør og melis hvitt. Rør inn den avkjølte vaniljekremen litt etter litt til en glatt smørkrem.","Del kaken i to eller tre lag. Bruk smørkremen både som fyll mellom lagene og som glasur på toppen og sidene.","Pynt kaken med 100 g sjokolade – enten ved å drysse over revet sjokolade eller ved å smelte sjokoladen og fordele den jevnt over glasuren.","La kaken trekke kjølig i minst 1 time før servering for å sette smakene."],"createdAt":"2025-08-18"},
            {"id":"recipe_1755524663629_mxj8jiua2","title":"Sjokolade- og mandelkake i langpanne","servings":"Ca. 20–25 ruter","provider":"Farmor","reference":"Håndskrevet oppskriftsbok, side 9","category":"Kake","meal":"Dessert","cuisine":"Skandinavisk","description":"En saftig langpannekake laget med sjokolade, sitronskall og hakkede mandler. Smør og sukker piskes hvitt, eggene blandes inn, og til slutt røres sjokolade, mandler og sitronskall inn i røren. Kaken stekes i langpanne og skjæres i firkanter når den er ferdig. Tradisjonelt serveres den uten glasur, men den kan gjerne pyntes med et lett dryss melis for et festligere preg.","image":"https://images.unsplash.com/photo-1601979039736-6f57c5b3e3ec?w=800&h=600&fit=crop","ingredients":["250 g smør","250 g sukker","250 g hvetemel","4 egg (plommer og hviter skilles)","100 g mørk sjokolade (smeltet)","revet skall av 1 sitron","50 g hakkede mandler","melis til pynt (valgfritt)"],"instructions":["Visp smør og sukker til det er hvitt og luftig.","Tilsett eggeplommene én etter én under omrøring.","Smelt sjokoladen og rør den inn sammen med revet sitronskall.","Sikt hvetemelet og vend det vekselvis inn med stivpiskede eggehviter.","Vend til slutt inn de hakkede mandlene.","Hell røren i en smurt og bakepapirkledd langpanne.","Stek kaken midt i ovnen ved 175 °C i ca. 30–35 minutter, til den er gjennomstekt.","Avkjøl og skjær i firkanter.","Dryss gjerne melis over kaken før servering."],"createdAt":"2025-08-18"},
            {"id":"recipe_1755525039501_v1gcazw3t","title":"Sjokoladesnitter","servings":"Ca. 30–40 snitter","provider":"Farmor","reference":"Håndskrevet oppskriftsbok, side 9","category":"Julekaker","meal":"Snacks","cuisine":"Skandinavisk","description":"Sjokoladesnitter er enkle, klassiske småkaker der en mørdeig smaksatt med kakao formes til lengder, stekes og skjæres i skrå snitter. Kakene blir sprø i kantene og litt seige i midten – en populær småkake til kaffebordet og i julen.","image":"https://images.unsplash.com/photo-1607082349566-187342175e2f?w=800&h=600&fit=crop","ingredients":["200 g smør","200 g sukker","1 egg","3 ss kakao","250 g hvetemel","2 ts potetmel","2 ts bakepulver","1 ts vaniljesukker"],"instructions":["Visp smør og sukker hvitt og luftig.","Tilsett egget og rør godt inn.","Sikt sammen kakao, hvetemel, potetmel, bakepulver og vaniljesukker.","Rør det tørre inn i smørblandingen og arbeid deigen raskt sammen.","Del deigen i 3–4 deler og rull ut til lengder.","Legg lengdene på bakepapirkledd stekebrett og trykk dem litt flate med en gaffel eller baksiden av en skje.","Stek midt i ovnen ved 175 °C i ca. 12–15 minutter.","Skjær lengdene i skrå snitter mens de fortsatt er varme.","La sjokoladesnittene avkjøles helt på rist og oppbevar i tett kakeboks."],"createdAt":"2025-08-18"},
            {"id":"recipe_1755525313393_x86s8trii","title":"Fru Meyers kaker","servings":"Ca. 40 småkaker","provider":"Farmor","reference":"Håndskrevet oppskriftsbok, side 10","category":"Julekaker","meal":"Snacks","cuisine":"Skandinavisk","description":"Fru Meyers kaker er klassiske småkaker laget med en enkel deig av margarin, sukker, potetmel og hvetemel. Kakene er lette og sprø, med en mild smak av sitron. De formes med teskje som små topper på platen og stekes til de er lys-gule. En tradisjonell småkake som passer godt både til kaffekosen og på julekakefatet.","image":"https://images.unsplash.com/photo-1607082350899-7f7e6fcefbdd?w=800&h=600&fit=crop","ingredients":["125 g margarin","125 g sukker","125 g potetmel","140 g hvetemel","1 egg","3/4 ts hornsalt (hjortetakksalt)","5 dråper sitronessens"],"instructions":["Rør margarin og sukker hvitt.","Pisk egget lett sammen og ha det i.","Sikt på mel og hornsalt og rør godt.","Ha i sitrondråper.","Sett små topper av deigen på platen med en teskje, litt mellomrom imellom.","Stekes lys-gule i svak varme (ca. 160–170 °C) i 8–10 minutter.","Avkjøles på rist og oppbevares i tett kakeboks."],"createdAt":"2025-08-18"},
            {"id":"recipe_1755525787550_591atv6ib","title":"Freia formkake","servings":"8–10 porsjoner","provider":"Farmor","reference":"Håndskrevet oppskriftsbok, side 11","category":"Kake","meal":"Dessert","cuisine":"Skandinavisk","description":"Freia formkake er en klassisk, enkel smørkake laget med både hvetemel og potetmel. Resultatet blir en saftig og lett kake med fin struktur. Den passer godt til kaffekos, og kan gjerne serveres naturell eller med et lett dryss melis. Oppskriften stammer trolig fra Freias bakepulverpakke.","image":"https://images.unsplash.com/photo-1618411640599-34f58f365f26?w=800&h=600&fit=crop","ingredients":["125 g smør","125 g sukker","70 g hvetemel","70 g potetmel","2 egg","1/2 ts bakepulver","1 ts vaniljesukker eller revet skall av 1/2 sitron (valgfritt, for smak)","melis til pynt (valgfritt)"],"instructions":["Rør smør og sukker hvitt.","Tilsett eggene, ett om gangen, og visp godt mellom hver.","Bland hvetemel, potetmel og bakepulver sammen, og sikt det i røren.","Vend forsiktig til alt er godt blandet. Tilsett gjerne vaniljesukker eller revet sitronskall for ekstra smak.","Hell røren i en smurt form (ca. 1 liter).","Stek kaken i middels varm ovn (ca. 175 °C) i omtrent 45 minutter, til den er gjennomstekt og gyllen.","Avkjøl på rist før servering.","Dryss gjerne melis over kaken før servering."],"createdAt":"2025-08-18"},
            {"id":"recipe_1755526142808_1e6hjyujv","title":"Brune snipper","servings":"Ca. 40–50 stk.","provider":"Farmor","category":"Småkaker","meal":"Julekaker","cuisine":"Norsk","description":"Brune snipper er klassiske julekaker laget med sirup, krydder og en klype pepper for ekstra smak. Deigen skal helst hvile til neste dag før utkjevling. Kakene kuttes i diamanter (snipper) og blir sprø og krydrede, perfekt til julens kakefat.","ingredients":["65 g sukker","35 g margarin","125 g sirup","3/4 dl fløte","250 g hvetemel","1/2 ts pepper","1/4 ts ingefær","1/2 ts natron","Ev. halve mandler til pynt"],"instructions":["Ha sukker, sirup og fløte i en kjele og varm opp til margarinen er smeltet. Rør godt sammen.","Avkjøl blandingen litt, og sikt inn alt det tørre (hvetemel, krydder og natron). Elt til en jevn deig.","La deigen hvile til neste dag, gjerne kjølig.","Kjevle ut deigen tynt, ca. 2–3 mm. Skjær ut snipper ved å først skjære lange strimler på skrå (3–4 cm brede), og deretter skjære på skrå den andre veien slik at det dannes små diamanter (ca. 4–5 cm på langsiden).","Legg snippene på smurt plate eller bakepapir. Pynt gjerne med en halv mandel i midten av hver.","Stek kakene i lys gyllen farge ved middels varme (ca. 175 °C) i 8–10 minutter."],"createdAt":"2025-08-18"},
            {"id":"recipe_09","title":"Bakepulverstenger","servings":"Ca. 30–40 stk.","provider":"Farmor","reference":"Side 17","category":"Småkaker","meal":"Kaffemat","cuisine":"Norsk","description":"Bakepulverstenger er enkle og luftige småkaker laget uten gjær. De formes som stenger, pensles med egg og strøs med grovt sukker for en gyllen og sprø overflate. Perfekt til kaffekosen.","ingredients":["500 g hvetemel","100 g margarin","100 g sukker","1 egg","2 1/2 dl melk","3 ts bakepulver","1 egg til pensling","Litt grovt sukker til topping"],"instructions":["Bland sammen hvetemel, sukker og bakepulver i en bolle.","Smuldre inn margarinen til det ligner grovt smuler.","Pisk egget lett og rør det inn sammen med melken. Arbeid deigen raskt sammen.","Del deigen i fire emner og trill ut til stenger.","Legg stengene på bakepapirkledd plate, pensle med sammenvispet egg og strø over grovt sukker.","Stek til de er lyse gylne ved ca. 200 °C i 10–12 minutter."],"createdAt":"2025-08-18"},
            {"id":"recipe_1755530008601_5c9sko0oi","title":"Wienerring","servings":"1 stor ring","provider":"Farmor","reference":"Håndskrevet oppskriftsbok, side 18","category":"Gjærbakst","meal":"Kake","cuisine":"Skandinavisk","description":"Wienerring er en klassisk gjærbakst fylt med en mild krem basert på fløte, vanilje og eggeplomme. Deigen rulles med fyll, formes til en ring og klippes opp slik at fyllet blir synlig under steking. Resultatet er en luftig og dekorativ festkake som passer perfekt på kaffebordet.","ingredients":[{"group":"Deig","items":["250 g hvetemel","50 g sukker","ca. 1 ¼ dl melk (lunken)","1 egg","40 g gjær","100 g smør","1 egg til pensling","Litt hakkede mandler til pynt"]},{"group":"Fyll","items":["1 eggeplomme","1 ½ dl fløte","½ ts vaniljesukker","1 ss potetmel","1 ss sukker"]}],"instructions":["Sikt sammen hvetemel og sukker i en bolle.","Løs opp gjæren i lunken melk og pisk inn egget.","Bland væsken i det tørre og elt deigen til den er smidig. Arbeid inn smøret til slutt. La heve til dobbel størrelse.","Lag fyllet: Pisk sammen fløte, eggeplomme, sukker, potetmel og vaniljesukker. Kok forsiktig opp under omrøring til en tykk krem. Avkjøl.","Kjevle deigen ut til et stort rektangel og fordel fyllet jevnt utover.","Rull deigen sammen fra langsiden til en lang pølse og legg den på et stekebrett med bakepapir.","Form pølsen til en stor ring og klem endene godt sammen.","Klipp skrå snitt med ca. 3 cm mellomrom nesten helt igjennom, og vri hvert stykke litt utover så fyllet synes.","Pensle med egg og dryss over hakkede mandler.","Stek ved 180 °C (varmluft) eller 200 °C (over- og undervarme) i ca. 25–30 minutter til den er gyllenbrun."],"createdAt":"2025-08-18"}
        ];

        // User data - automatically saved to localStorage
        let userData = {};

        // Helper function to find recipe by ID
        function findRecipeById(recipeId) {
            return recipeDatabase.find(recipe => recipe.id === recipeId);
        }

        // Load user data from localStorage
        function loadData() {
            const storedUserData = localStorage.getItem('userData');
            if (storedUserData) {
                userData = JSON.parse(storedUserData);
            }
        }

        // Save user data to localStorage
        function saveData() {
            localStorage.setItem('userData', JSON.stringify(userData));
        }

        // Get recipe with user data merged
        function getRecipeWithUserData(recipeId) {
            const recipe = findRecipeById(recipeId);
            if (!recipe) return null;
            
            const userInfo = userData[recipeId] || {
                userRating: null,
                madeDates: [],
                lastViewed: null,
                favorite: false
            };
            return { ...recipe, ...userInfo };
        }

        // Initialize user data for new recipe
        function initializeUserData(recipeId) {
            if (!userData[recipeId]) {
                userData[recipeId] = {
                    userRating: null,
                    madeDates: [],
                    lastViewed: null,
                    viewCount: 0,
                    favorite: false
                };
            }
        }

        // Get unique categories, meals and cuisines from recipes
        function getRecipeFilters() {
            const categories = new Set();
            const meals = new Set();
            const cuisines = new Set();
            
            recipeDatabase.forEach(recipe => {
                if (recipe.category) categories.add(recipe.category);
                if (recipe.meal) meals.add(recipe.meal);
                if (recipe.cuisine) cuisines.add(recipe.cuisine);
            });
            
            return {
                categories: Array.from(categories).sort(),
                meals: Array.from(meals).sort(),
                cuisines: Array.from(cuisines).sort()
            };
        }

        // Activate filter by clicking on category/meal/cuisine
        function activateFilter(filterType, filterValue, event) {
            if (event) {
                event.stopPropagation();
            }
            
            const filterKey = `${filterType}:${filterValue}`;
            
            // Close modal if it's open
            const modal = document.getElementById('recipeModal');
            if (!modal.classList.contains('hidden')) {
                closeRecipe();
            }
            
            // Add filter if not already active
            if (!activeFilters.has(filterKey)) {
                activeFilters.set(filterKey, true);
                renderFilterPills();
                updateFilterButton();
                applyFilters();
                renderFilterOptions();
                updateRecommendationsVisibility();
            }
        }

        // Render filter options in dropdown
        function renderFilterOptions() {
            const container = document.getElementById('filterOptions');
            const filters = getRecipeFilters();
            
            container.innerHTML = '';
            
            // Category filters
            if (filters.categories.length > 0) {
                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'text-xs font-semibold text-gray-500 uppercase tracking-wider px-2 pt-1 pb-1';
                categoryHeader.textContent = 'Kategori';
                container.appendChild(categoryHeader);
                
                filters.categories.forEach(category => {
                    const isSelected = activeFilters.has(`category:${category}`);
                    const option = document.createElement('label');
                    option.className = 'flex items-center justify-between p-2 hover:bg-amber-50 rounded-lg cursor-pointer transition-colors';
                    option.innerHTML = `
                        <span class="text-sm text-gray-700">${category}</span>
                        <input type="checkbox" 
                               ${isSelected ? 'checked' : ''} 
                               onchange="toggleFilterType('category:${category}')"
                               onclick="event.stopPropagation()"
                               class="rounded border-gray-300 text-amber-600 focus:ring-amber-500 cursor-pointer">
                    `;
                    container.appendChild(option);
                });
            }
            
            // Meal filters
            if (filters.meals.length > 0) {
                const mealHeader = document.createElement('div');
                mealHeader.className = 'text-xs font-semibold text-gray-500 uppercase tracking-wider px-2 pt-3 pb-1';
                mealHeader.textContent = 'Måltid';
                container.appendChild(mealHeader);
                
                filters.meals.forEach(meal => {
                    const isSelected = activeFilters.has(`meal:${meal}`);
                    const option = document.createElement('label');
                    option.className = 'flex items-center justify-between p-2 hover:bg-amber-50 rounded-lg cursor-pointer transition-colors';
                    option.innerHTML = `
                        <span class="text-sm text-gray-700">${meal}</span>
                        <input type="checkbox" 
                               ${isSelected ? 'checked' : ''} 
                               onchange="toggleFilterType('meal:${meal}')"
                               onclick="event.stopPropagation()"
                               class="rounded border-gray-300 text-amber-600 focus:ring-amber-500 cursor-pointer">
                    `;
                    container.appendChild(option);
                });
            }
            
            // Cuisine filters
            if (filters.cuisines.length > 0) {
                const cuisineHeader = document.createElement('div');
                cuisineHeader.className = 'text-xs font-semibold text-gray-500 uppercase tracking-wider px-2 pt-3 pb-1';
                cuisineHeader.textContent = 'Kjøkken';
                container.appendChild(cuisineHeader);
                
                filters.cuisines.forEach(cuisine => {
                    const isSelected = activeFilters.has(`cuisine:${cuisine}`);
                    const option = document.createElement('label');
                    option.className = 'flex items-center justify-between p-2 hover:bg-amber-50 rounded-lg cursor-pointer transition-colors';
                    option.innerHTML = `
                        <span class="text-sm text-gray-700">${cuisine}</span>
                        <input type="checkbox" 
                               ${isSelected ? 'checked' : ''} 
                               onchange="toggleFilterType('cuisine:${cuisine}')"
                               onclick="event.stopPropagation()"
                               class="rounded border-gray-300 text-amber-600 focus:ring-amber-500 cursor-pointer">
                    `;
                    container.appendChild(option);
                });
            }
        }

        // Check if search or filters are active
        function hasActiveSearchOrFilters() {
            return searchQuery.length > 0 || activeFilters.size > 0;
        }

        // Update recommendations visibility
        function updateRecommendationsVisibility() {
            const recommendationsSection = document.getElementById('recommendationsSection');
            if (hasActiveSearchOrFilters()) {
                recommendationsSection.style.display = 'none';
            } else {
                recommendationsSection.style.display = 'block';
            }
        }

        // Toggle filter type selection
        function toggleFilterType(type) {
            if (activeFilters.has(type)) {
                activeFilters.delete(type);
            } else {
                activeFilters.set(type, true);
            }
            renderFilterPills();
            updateFilterButton();
            applyFilters();
            renderFilterOptions();
            updateRecommendationsVisibility();
        }

        // Render filter pills
        function renderFilterPills() {
            const container = document.getElementById('filterPillsContainer');
            const hasFilters = activeFilters.size > 0;
            
            container.innerHTML = '';
            
            // Hide pills if more than 3 filters
            if (activeFilters.size > 3) {
                container.style.maxWidth = '0';
                container.style.opacity = '0';
            } else {
                container.style.maxWidth = hasFilters ? '100%' : '0';
                container.style.opacity = hasFilters ? '1' : '0';
                
                let pillCount = 0;
                activeFilters.forEach((isActive, filterKey) => {
                    if (pillCount >= 3) return; // Max 3 pills
                    
                    const [filterType, filterValue] = filterKey.split(':');
                    const displayName = filterValue || filterKey;
                    
                    const pill = document.createElement('div');
                    pill.className = `filter-pill flex items-center gap-1 px-3 py-1.5 rounded-full text-sm transition-all shadow-sm ${
                        isActive 
                            ? 'bg-gradient-to-r from-amber-500 to-amber-600 text-white' 
                            : 'bg-gray-200 text-gray-500 opacity-60'
                    }`;
                    pill.innerHTML = `
                        <span class="filter-pill-text cursor-pointer font-medium" onclick="togglePillActive('${filterKey}')">${displayName}</span>
                        <button onclick="removeFilter('${filterKey}')" class="ml-1 hover:opacity-70 flex-shrink-0">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    `;
                    container.appendChild(pill);
                    pillCount++;
                });
            }
            
            // Update clear button visibility
            const clearBtn = document.getElementById('clearFilters');
            if (hasFilters) {
                clearBtn.classList.remove('opacity-0', 'pointer-events-none');
                clearBtn.classList.add('opacity-100');
            } else {
                clearBtn.classList.add('opacity-0', 'pointer-events-none');
                clearBtn.classList.remove('opacity-100');
            }
        }

        // Toggle pill active/inactive state
        function togglePillActive(type) {
            if (activeFilters.has(type)) {
                activeFilters.set(type, !activeFilters.get(type));
                renderFilterPills();
                applyFilters();
            }
        }

        // Remove filter
        function removeFilter(type) {
            activeFilters.delete(type);
            renderFilterPills();
            updateFilterButton();
            applyFilters();
            renderFilterOptions();
            updateRecommendationsVisibility();
        }

        // Update filter button state
        function updateFilterButton() {
            const btn = document.getElementById('filterToggle');
            const count = document.getElementById('filterCount');
            const hasFilters = activeFilters.size > 0;
            
            btn.className = 'flex items-center space-x-2 px-4 py-2 rounded-xl transition-all text-sm font-medium shrink-0 shadow-sm hover:shadow-md';
            
            if (hasFilters) {
                btn.classList.add('bg-gradient-to-r', 'from-amber-500', 'to-amber-600', 'text-white', 'hover:from-amber-600', 'hover:to-amber-700');
                count.textContent = activeFilters.size;
                count.classList.remove('hidden');
                count.classList.add('bg-white/30');
            } else {
                btn.classList.add('bg-white', 'text-gray-700', 'hover:text-amber-600', 'border', 'border-gray-200');
                count.classList.add('hidden');
            }
        }

        // Toggle filter menu
        function toggleFilterMenu() {
            const menu = document.querySelector('#filterMenu > div');
            
            if (!filterMenuOpen) {
                renderFilterOptions();
                menu.classList.remove('hidden');
                filterMenuOpen = true;
            } else {
                menu.classList.add('hidden');
                filterMenuOpen = false;
            }
        }

        // Clear all filters
        function clearAllFilters() {
            activeFilters.clear();
            renderFilterPills();
            updateFilterButton();
            applyFilters();
            renderFilterOptions();
            updateRecommendationsVisibility();
        }

        // Apply both search and type filters
        function applyFilters() {
            let filtered = [...recipeDatabase];  // Start with full array
            
            // Apply filters
            const activeCategoryFilters = [];
            const activeMealFilters = [];
            const activeCuisineFilters = [];
            
            activeFilters.forEach((isActive, filterKey) => {
                if (!isActive) return;
                
                const [filterType, filterValue] = filterKey.split(':');
                if (filterType === 'category') {
                    activeCategoryFilters.push(filterValue);
                } else if (filterType === 'meal') {
                    activeMealFilters.push(filterValue);
                } else if (filterType === 'cuisine') {
                    activeCuisineFilters.push(filterValue);
                }
            });
            
            // Filter by category
            if (activeCategoryFilters.length > 0) {
                filtered = filtered.filter(recipe => 
                    activeCategoryFilters.includes(recipe.category)
                );
            }
            
            // Filter by meal type
            if (activeMealFilters.length > 0) {
                filtered = filtered.filter(recipe => 
                    activeMealFilters.includes(recipe.meal)
                );
            }
            
            // Filter by cuisine type
            if (activeCuisineFilters.length > 0) {
                filtered = filtered.filter(recipe => 
                    activeCuisineFilters.includes(recipe.cuisine)
                );
            }
            
            // Apply search filter
            if (searchQuery) {
                filtered = filtered.filter(recipe => {
                    const titleMatch = recipe.title.toLowerCase().includes(searchQuery);
                    
                    // Handle both grouped and non-grouped ingredient formats
                    let ingredientMatch = false;
                    if (recipe.ingredients) {
                        recipe.ingredients.forEach(item => {
                            if (typeof item === 'string') {
                                if (item.toLowerCase().includes(searchQuery)) {
                                    ingredientMatch = true;
                                }
                            } else if (item.items) {
                                item.items.forEach(ing => {
                                    if (ing.toLowerCase().includes(searchQuery)) {
                                        ingredientMatch = true;
                                    }
                                });
                            }
                        });
                    }
                    
                    return titleMatch || ingredientMatch;
                });
            }
            
            // Extract IDs from filtered recipes
            const filteredIds = filtered.map(recipe => recipe.id);
            renderRecipes(filteredIds);
        }

        // Close filter menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('filterMenu');
            const toggle = document.getElementById('filterToggle');
            
            if (filterMenuOpen && 
                !menu.contains(e.target) && 
                !toggle.contains(e.target)) {
                toggleFilterMenu();
            }
        });

        // Render recipes
        function renderRecipes(recipesToRender = null) {
            const grid = document.getElementById('recipeGrid');
            grid.innerHTML = '';
            
            const recipeIds = recipesToRender || recipeDatabase.map(r => r.id);
            
            recipeIds.forEach(recipeId => {
                const recipeData = getRecipeWithUserData(recipeId);
                if (recipeData) {
                    const card = createRecipeCard(recipeData);
                    grid.appendChild(card);
                }
            });
        }

        // Create recipe card
        function createRecipeCard(recipe) {
            const card = document.createElement('div');
            card.className = 'recipe-card bg-white rounded-xl shadow-md overflow-hidden cursor-pointer hover:shadow-xl';
            card.setAttribute('data-recipe-id', recipe.id);
            card.onclick = () => showRecipe(recipe.id);
            
            const imageUrl = recipe.image || `https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=800&h=600&fit=crop`;
            
            card.innerHTML = `
                <div class="h-48 bg-gradient-to-br from-amber-100 to-orange-100 relative overflow-hidden">
                    ${recipe.image ? `<img src="${imageUrl}" alt="${recipe.title}" class="w-full h-full object-cover">` : 
                    `<div class="w-full h-full flex items-center justify-center">
                        <span class="text-6xl opacity-30">🍞</span>
                    </div>`}
                    ${recipe.category ? `<span onclick="activateFilter('category', '${recipe.category}', event)" class="category-badge absolute top-2 right-2 bg-white/90 backdrop-blur text-xs font-medium px-2 py-1 rounded-full text-amber-700">${recipe.category}</span>` : ''}
                </div>
                <div class="p-5">
                    <h3 class="font-display text-xl text-gray-800 ${recipe.provider ? 'mb-0' : 'mb-2'}">${recipe.title}</h3>
                    ${recipe.provider ? `<p class="text-xs text-amber-600 mb-2">${recipe.provider}s oppskrift</p>` : ''}
                    <p class="text-gray-600 text-sm mb-3">${recipe.servings}</p>
                    <div class="flex items-center justify-between">
                        <div class="recipe-stars flex items-center space-x-1">
                            ${renderStars(recipe.userRating || 0)}
                        </div>
                        <div class="flex items-center text-sm text-gray-600">
                            <span class="mr-1">👨‍🍳</span>
                            <span class="recipe-counter">${recipe.madeDates ? recipe.madeDates.length : 0}</span>
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }

        // Render ingredients (handles both grouped and non-grouped formats)
        function renderIngredients(ingredients) {
            if (!ingredients || ingredients.length === 0) return '';
            
            // Check if ingredients are grouped
            const hasGroups = ingredients.some(item => typeof item === 'object' && item.group);
            
            if (!hasGroups) {
                // Simple list format
                return `
                    <ul class="space-y-2">
                        ${ingredients.map(ing => `
                            <li class="flex items-start">
                                <span class="text-amber-600 mr-2">•</span>
                                <span class="text-gray-700">${ing}</span>
                            </li>
                        `).join('')}
                    </ul>
                `;
            } else {
                // Grouped format
                return ingredients.map((group, index) => {
                    if (typeof group === 'string') {
                        return `
                            <ul class="space-y-2 ${index > 0 ? 'mt-4' : ''}">
                                <li class="flex items-start">
                                    <span class="text-amber-600 mr-2">•</span>
                                    <span class="text-gray-700">${group}</span>
                                </li>
                            </ul>
                        `;
                    }
                    
                    return `
                        <div class="${index > 0 ? 'mt-5' : ''}">
                            <h4 class="font-semibold text-sm text-amber-700 mb-2">${group.group}:</h4>
                            <ul class="space-y-2">
                                ${group.items.map(ing => `
                                    <li class="flex items-start">
                                        <span class="text-amber-600 mr-2">•</span>
                                        <span class="text-gray-700">${ing}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                }).join('');
            }
        }

        // Render star rating
        function renderStars(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += '<span class="text-amber-400">★</span>';
                } else {
                    stars += '<span class="text-gray-300">★</span>';
                }
            }
            return stars;
        }

        // Check if device is mobile
        function isMobile() {
            return window.innerWidth <= 640;
        }

        // Show recipe modal
        function showRecipe(recipeId) {
            const recipe = getRecipeWithUserData(recipeId);
            if (!recipe) return;
            
            // Update view tracking
            if (!userData[recipeId]) {
                initializeUserData(recipeId);
            }
            userData[recipeId].lastViewed = new Date().toISOString();
            userData[recipeId].viewCount = (userData[recipeId].viewCount || 0) + 1;
            saveData();
            
            const modal = document.getElementById('recipeModal');
            const content = document.getElementById('modalContent');
            
            const imageUrl = recipe.image || `https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=800&h=600&fit=crop`;
            
            // Check if recipe was made today
            const today = new Date().toISOString().split('T')[0];
            const madeToday = recipe.madeDates && recipe.madeDates.includes(today);
            const madeCount = recipe.madeDates ? recipe.madeDates.length : 0;
            
            // Mobile-specific layout
            if (isMobile()) {
                content.innerHTML = `
                    <div class="relative flex flex-col h-full overflow-y-auto modal-scroll-mobile">
                        <button onclick="closeRecipe()" class="modal-close-mobile bg-white/90 backdrop-blur rounded-full p-2 hover:bg-white shadow-lg">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                        <div class="h-56 bg-gradient-to-br from-amber-100 to-orange-100 relative flex-shrink-0">
                            ${recipe.image ? `<img src="${imageUrl}" alt="${recipe.title}" class="w-full h-full object-cover">` : 
                            `<div class="w-full h-full flex items-center justify-center">
                                <span class="text-8xl opacity-30">🍞</span>
                            </div>`}
                            ${recipe.category ? `<span onclick="activateFilter('category', '${recipe.category}', event)" class="category-badge absolute top-4 left-4 bg-white/90 backdrop-blur text-xs font-medium px-2 py-1 rounded-full text-amber-700">${recipe.category}</span>` : ''}
                        </div>
                        <div class="flex-1 px-4 pb-12 bg-white">
                            <div class="pt-4 pb-3">
                                <h2 class="font-display text-2xl text-gray-800 ${recipe.provider ? 'mb-0' : 'mb-1'}">${recipe.title}</h2>
                                ${recipe.provider ? `<p class="text-xs text-amber-600 mb-2">${recipe.provider}s oppskrift</p>` : ''}
                                <p class="text-gray-600 text-sm mb-3">${recipe.servings}</p>
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center">
                                        ${renderInteractiveStars(recipe)}
                                    </div>
                                    <button onclick="toggleMadeToday('${recipe.id}', event)" 
                                            class="flex items-center space-x-1 px-3 py-1.5 rounded-lg transition text-xs font-medium
                                                   ${madeToday 
                                                     ? 'bg-amber-600 text-white' 
                                                     : 'border border-gray-300 text-gray-600 hover:bg-gray-50'}">
                                        <svg class="w-4 h-4" fill="${madeToday ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        <span>Laget (${madeCount})</span>
                                    </button>
                                </div>
                                ${recipe.cuisine || recipe.meal ? `
                                <div class="text-xs text-gray-500">
                                    ${recipe.cuisine ? `<span onclick="activateFilter('cuisine', '${recipe.cuisine}', event)" class="category-badge inline-block px-2 py-0.5 bg-gray-100 rounded-full cursor-pointer hover:bg-amber-100">${recipe.cuisine} kjøkken</span>` : ''}
                                    ${recipe.cuisine && recipe.meal ? ' ' : ''}
                                    ${recipe.meal ? `<span onclick="activateFilter('meal', '${recipe.meal}', event)" class="category-badge inline-block px-2 py-0.5 bg-gray-100 rounded-full cursor-pointer hover:bg-amber-100">${recipe.meal}</span>` : ''}
                                </div>
                                ` : ''}
                            </div>
                            
                            ${recipe.description ? `
                            <div class="pb-4">
                                <p class="text-gray-700 text-sm leading-relaxed">${recipe.description}</p>
                            </div>
                            ` : ''}
                            
                            <div class="space-y-6">
                                <div>
                                    <h3 class="font-display text-xl text-amber-800 mb-3">Ingredienser</h3>
                                    ${renderIngredients(recipe.ingredients)}
                                </div>
                                
                                <div>
                                    <h3 class="font-display text-xl text-amber-800 mb-3">Fremgangsmåte</h3>
                                    <ol class="space-y-3">
                                        ${recipe.instructions.map((inst, i) => `
                                            <li class="flex items-start">
                                                <span class="font-semibold text-amber-600 mr-3 flex-shrink-0">${i + 1}.</span>
                                                <span class="text-gray-700 text-sm">${inst}</span>
                                            </li>
                                        `).join('')}
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Desktop layout
                content.innerHTML = `
                    <div class="relative flex flex-col h-full">
                        <button onclick="closeRecipe()" class="absolute top-4 right-4 bg-white/90 backdrop-blur rounded-full p-2 hover:bg-white z-10 shadow-lg">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                        <div class="h-56 bg-gradient-to-br from-amber-100 to-orange-100 relative flex-shrink-0">
                            ${recipe.image ? `<img src="${imageUrl}" alt="${recipe.title}" class="w-full h-full object-cover">` : 
                            `<div class="w-full h-full flex items-center justify-center">
                                <span class="text-8xl opacity-30">🍞</span>
                            </div>`}
                            ${recipe.category ? `<span onclick="activateFilter('category', '${recipe.category}', event)" class="category-badge absolute top-4 left-6 bg-white/90 backdrop-blur text-xs font-medium px-2 py-1 rounded-full text-amber-700">${recipe.category}</span>` : ''}
                        </div>
                        <div class="flex-1 flex flex-col overflow-hidden bg-white">
                            <div class="px-6 pt-5 pb-4 flex-shrink-0 border-b border-gray-100">
                                <h2 class="font-display text-3xl text-gray-800 ${recipe.provider ? 'mb-0' : 'mb-1'}">${recipe.title}</h2>
                                ${recipe.provider ? `<p class="text-xs text-amber-600 mb-2">${recipe.provider}s oppskrift</p>` : ''}
                                <p class="text-gray-600 text-sm mb-3">${recipe.servings}</p>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-4">
                                        <div class="flex items-center">
                                            ${renderInteractiveStars(recipe)}
                                        </div>
                                        ${recipe.cuisine || recipe.meal ? `
                                        <div class="text-sm text-gray-500">
                                            ${recipe.cuisine ? `<span onclick="activateFilter('cuisine', '${recipe.cuisine}', event)" class="category-badge inline-block px-2 py-0.5 bg-gray-100 rounded-full cursor-pointer hover:bg-amber-100">${recipe.cuisine} kjøkken</span>` : ''}
                                            ${recipe.cuisine && recipe.meal ? ' ' : ''}
                                            ${recipe.meal ? `<span onclick="activateFilter('meal', '${recipe.meal}', event)" class="category-badge inline-block px-2 py-0.5 bg-gray-100 rounded-full cursor-pointer hover:bg-amber-100">${recipe.meal}</span>` : ''}
                                        </div>
                                        ` : ''}
                                    </div>
                                    <button onclick="toggleMadeToday('${recipe.id}', event)" 
                                            class="flex items-center space-x-2 px-3 py-1.5 rounded-lg transition text-sm font-medium
                                                   ${madeToday 
                                                     ? 'bg-amber-600 text-white hover:bg-amber-700' 
                                                     : 'border border-gray-300 text-gray-600 hover:bg-gray-50'}">
                                        <svg class="w-5 h-5" fill="${madeToday ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        <span>Laget (${madeCount})</span>
                                    </button>
                                </div>
                            </div>
                            
                            ${recipe.description ? `
                            <div class="px-6 py-4 flex-shrink-0 bg-amber-50/30">
                                <p class="text-gray-700 leading-relaxed">${recipe.description}</p>
                            </div>
                            ` : ''}
                            
                            <div class="grid md:grid-cols-2 gap-6 px-6 py-6 flex-1 overflow-hidden">
                                <div class="flex flex-col">
                                    <h3 class="font-display text-xl text-amber-800 mb-3 flex-shrink-0">Ingredienser</h3>
                                    <div class="overflow-y-auto pr-2 pb-8 recipe-scroll" style="max-height: calc(100vh - ${recipe.description ? '580' : '480'}px);">
                                        ${renderIngredients(recipe.ingredients)}
                                    </div>
                                </div>
                                
                                <div class="flex flex-col">
                                    <h3 class="font-display text-xl text-amber-800 mb-3 flex-shrink-0">Fremgangsmåte</h3>
                                    <div class="overflow-y-auto pr-2 pb-8 recipe-scroll" style="max-height: calc(100vh - ${recipe.description ? '580' : '480'}px);">
                                        <ol class="space-y-3">
                                            ${recipe.instructions.map((inst, i) => `
                                                <li class="flex items-start">
                                                    <span class="font-semibold text-amber-600 mr-3 flex-shrink-0">${i + 1}.</span>
                                                    <span class="text-gray-700">${inst}</span>
                                                </li>
                                            `).join('')}
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Lock body scroll
            scrollPosition = window.pageYOffset;
            document.body.classList.add('modal-open');
            document.body.style.top = `-${scrollPosition}px`;
            modal.classList.remove('hidden');
        }

        // Render interactive stars for rating
        function renderInteractiveStars(recipe) {
            let stars = '';
            const userRating = recipe.userRating || 0;
            for (let i = 1; i <= 5; i++) {
                const filled = i <= userRating;
                stars += `<button onclick="rateRecipe('${recipe.id}', ${i}, event)" class="star text-2xl ${filled ? 'text-amber-400' : 'text-gray-300'} hover:text-amber-500">★</button>`;
            }
            return stars;
        }

        // Close recipe modal
        function closeRecipe() {
            document.getElementById('recipeModal').classList.add('hidden');
            // Restore body scroll
            document.body.classList.remove('modal-open');
            document.body.style.top = '';
            window.scrollTo(0, scrollPosition);
        }

        // Rate recipe
        function rateRecipe(recipeId, rating, event) {
            if (event) {
                event.stopPropagation();
            }
            
            if (!userData[recipeId]) {
                initializeUserData(recipeId);
            }
            
            userData[recipeId].userRating = rating;
            saveData();
            
            // Update stars without rebuilding modal
            const button = event ? event.currentTarget : null;
            if (button && button.parentElement) {
                const starsContainer = button.parentElement;
                const stars = starsContainer.querySelectorAll('button');
                stars.forEach((star, index) => {
                    if (index < rating) {
                        star.classList.remove('text-gray-300');
                        star.classList.add('text-amber-400');
                    } else {
                        star.classList.remove('text-amber-400');
                        star.classList.add('text-gray-300');
                    }
                });
            }
            
            // Update the rating in the grid cards
            updateRecipeCardRating(recipeId, rating);
            
            // Refresh recommendations after rating
            setTimeout(() => getRecommendations(), 100);
        }
        
        // Update recipe card rating in the grid
        function updateRecipeCardRating(recipeId, rating) {
            const cards = document.querySelectorAll(`[data-recipe-id="${recipeId}"]`);
            cards.forEach(card => {
                const starsContainer = card.querySelector('.recipe-stars');
                if (starsContainer) {
                    starsContainer.innerHTML = renderStars(rating);
                }
            });
        }

        // Toggle made today
        function toggleMadeToday(recipeId, event) {
            if (event) {
                event.stopPropagation();
            }
            
            if (!userData[recipeId]) {
                initializeUserData(recipeId);
            }
            
            const today = new Date().toISOString().split('T')[0];
            const madeDates = userData[recipeId].madeDates || [];
            
            const todayIndex = madeDates.indexOf(today);
            if (todayIndex > -1) {
                madeDates.splice(todayIndex, 1);
            } else {
                madeDates.push(today);
            }
            
            userData[recipeId].madeDates = madeDates;
            saveData();
            
            // Update button appearance without rebuilding modal
            const madeToday = madeDates.includes(today);
            const madeCount = madeDates.length;
            const button = event ? event.currentTarget : document.querySelector(`button[onclick*="toggleMadeToday('${recipeId}'"]`);
            
            if (button) {
                // Update button classes
                if (isMobile()) {
                    button.className = `flex items-center space-x-1 px-3 py-1.5 rounded-lg transition text-xs font-medium ${
                        madeToday 
                            ? 'bg-amber-600 text-white' 
                            : 'border border-gray-300 text-gray-600 hover:bg-gray-50'
                    }`;
                } else {
                    button.className = `flex items-center space-x-2 px-3 py-1.5 rounded-lg transition text-sm font-medium ${
                        madeToday 
                            ? 'bg-amber-600 text-white hover:bg-amber-700' 
                            : 'border border-gray-300 text-gray-600 hover:bg-gray-50'
                    }`;
                }
                
                // Update button content
                button.innerHTML = `
                    <svg class="${isMobile() ? 'w-4 h-4' : 'w-5 h-5'}" fill="${madeToday ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span>Laget (${madeCount})</span>
                `;
            }
            
            // Update the cooked counter in the grid
            updateRecipeCardCounter(recipeId, madeCount);
            
            // Refresh recommendations
            setTimeout(() => getRecommendations(), 100);
        }
        
        // Update recipe card counter in the grid
        function updateRecipeCardCounter(recipeId, count) {
            const cards = document.querySelectorAll(`[data-recipe-id="${recipeId}"]`);
            cards.forEach(card => {
                const counterElement = card.querySelector('.recipe-counter');
                if (counterElement) {
                    counterElement.textContent = count;
                }
            });
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
            searchQuery = e.target.value.toLowerCase();
            applyFilters();
            updateRecommendationsVisibility();
        });

        // Get recommendations
        function getRecommendations() {
            const recommended = document.getElementById('recommendedRecipes');
            
            let recs = [];
            const recipeIds = recipeDatabase.map(r => r.id);
            
            const threeDaysAgo = new Date();
            threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
            
            // Recently viewed but not in the last 3 days
            const oldViewed = recipeIds.filter(id => {
                const lastViewed = userData[id]?.lastViewed;
                if (!lastViewed) return false;
                const viewedDate = new Date(lastViewed);
                return viewedDate < threeDaysAgo;
            }).slice(0, 2);
            
            // Never viewed
            const neverViewed = recipeIds.filter(id => !userData[id]?.lastViewed).slice(0, 2);
            
            // Highly rated
            const highRated = recipeIds
                .filter(id => (userData[id]?.userRating || 0) > 3)
                .sort((a, b) => (userData[b]?.userRating || 0) - (userData[a]?.userRating || 0))
                .slice(0, 2);
            
            // Combine recommendations (unique)
            const recIdSet = new Set();
            [...oldViewed, ...neverViewed, ...highRated].forEach(id => {
                if (!recIdSet.has(id) && recs.length < 3) {
                    recIdSet.add(id);
                    recs.push(id);
                }
            });
            
            // If we don't have 3 recommendations, add random ones
            while (recs.length < 3 && recs.length < recipeIds.length) {
                const randomId = recipeIds[Math.floor(Math.random() * recipeIds.length)];
                if (!recIdSet.has(randomId)) {
                    recIdSet.add(randomId);
                    recs.push(randomId);
                }
            }
            
            recommended.innerHTML = '';
            recs.forEach(recipeId => {
                const recipeData = getRecipeWithUserData(recipeId);
                if (recipeData) {
                    const card = createRecipeCard(recipeData);
                    recommended.appendChild(card);
                }
            });
        }

        // Close modal on outside click
        document.getElementById('recipeModal').addEventListener('click', (e) => {
            const modalContent = document.querySelector('#recipeModal > div > div');
            if (!modalContent.contains(e.target)) {
                closeRecipe();
            }
        });

        // Initialize
        loadData();
        updateFilterButton();
        renderRecipes();
        getRecommendations();
        updateRecommendationsVisibility();
    </script>
</body>
</html>
