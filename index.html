<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Mine Oppskrifter - Hjemmelaget og Koselig</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .font-display {
            font-family: 'Playfair Display', serif;
        }
        .recipe-card {
            transition: all 0.3s ease;
        }
        .recipe-card:hover {
            transform: translateY(-4px);
        }
        .star {
            transition: all 0.2s ease;
        }
        .star:hover {
            transform: scale(1.2);
        }
        button svg {
            transition: transform 0.2s ease;
        }
        button:active svg {
            transform: scale(0.9);
        }
        /* Filter animations */
        #filterPillsContainer {
            transition: max-width 0.3s ease-out, opacity 0.3s ease-out;
        }
        #filterToggle {
            transition: all 0.2s ease;
        }
        #clearFilters {
            transition: opacity 0.2s ease;
        }
        /* Checkbox styling */
        input[type="checkbox"] {
            cursor: pointer;
        }
        input[type="checkbox"]:checked {
            background-color: rgb(217 119 6);
            border-color: rgb(217 119 6);
        }
        /* Custom scrollbar for recipe sections */
        .recipe-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .recipe-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        .recipe-scroll::-webkit-scrollbar-thumb {
            background: #d4d4d4;
            border-radius: 3px;
        }
        .recipe-scroll::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        /* Body lock when modal is open */
        body.modal-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
        }
        /* Mobile modal styles with Safari support */
        @supports (height: 100dvh) {
            .modal-height-mobile {
                height: 100dvh !important;
            }
        }
        @supports not (height: 100dvh) {
            .modal-height-mobile {
                height: 100vh !important;
                height: -webkit-fill-available !important;
            }
        }
        @media (max-width: 640px) {
            #recipeModal {
                padding: 0 !important;
            }
            .modal-content-mobile {
                height: 100vh;
                height: 100dvh;
                height: -webkit-fill-available;
                width: 100vw !important;
                max-width: 100vw !important;
                border-radius: 0 !important;
                margin: 0 !important;
            }
            .modal-scroll-mobile {
                overflow-y: auto !important;
                max-height: none !important;
                padding-bottom: calc(env(safe-area-inset-bottom, 20px) + 40px);
            }
            .modal-close-mobile {
                position: fixed !important;
                top: 16px !important;
                right: 16px !important;
                z-index: 50 !important;
            }
        }
        /* Modern input focus styles */
        .modern-input:focus {
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
        }
        /* Filter menu shadow */
        .filter-menu-shadow {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        /* Safe area padding for iOS */
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom, 0);
        }
        .safe-top {
            padding-top: env(safe-area-inset-top, 0);
        }
        /* Category badge hover effect */
        .category-badge {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .category-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-orange-50 via-amber-50 to-yellow-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white/90 backdrop-blur-sm shadow-sm sticky top-0 z-40 safe-top">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <h1 class="font-display text-3xl text-amber-800">Mine Oppskrifter</h1>
            </div>
        </div>
    </header>

    <!-- Search Bar -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
        <div class="bg-white/95 backdrop-blur rounded-2xl shadow-lg border border-white/50 p-1.5">
            <div class="relative">
                <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <input type="text" id="searchInput" placeholder="Søk etter oppskrifter eller ingredienser..." 
                       class="modern-input w-full pl-12 pr-4 py-3 bg-gray-50/50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-amber-400 focus:bg-white transition-all text-gray-700 placeholder-gray-400">
            </div>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-4">
        <div class="bg-white/95 backdrop-blur rounded-2xl shadow-lg border border-white/50 p-4 flex items-center justify-between">
            <div class="flex items-center gap-3 flex-1">
                <!-- Filter Button -->
                <button id="filterToggle" onclick="toggleFilterMenu()" 
                        class="flex items-center space-x-2 px-4 py-2 rounded-xl transition-all text-sm font-medium shrink-0 shadow-sm hover:shadow-md">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                    </svg>
                    <span>Filter</span>
                    <span id="filterCount" class="hidden bg-white/30 text-white text-xs px-1.5 py-0.5 rounded-full font-semibold">0</span>
                </button>
                
                <!-- Filter Pills Container -->
                <div id="filterPillsContainer" class="flex flex-wrap gap-2 overflow-hidden transition-all duration-300">
                    <!-- Filter pills will be inserted here -->
                </div>
            </div>
            
            <!-- Clear Filters Button -->
            <button id="clearFilters" onclick="clearAllFilters()" 
                    class="text-xs text-gray-500 hover:text-amber-600 transition-all opacity-0 pointer-events-none font-medium px-3 py-1 rounded-lg hover:bg-amber-50">
                Tøm filter
            </button>
        </div>
        
        <!-- Filter Dropdown Menu -->
        <div id="filterMenu" class="relative">
            <div class="absolute top-2 left-0 bg-white rounded-xl filter-menu-shadow border border-gray-100 p-4 z-30 hidden min-w-[280px]">
                <div class="text-sm font-semibold text-gray-700 mb-3">Velg kategorier</div>
                <div id="filterOptions" class="space-y-1 max-h-96 overflow-y-auto">
                    <!-- Filter options will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Recommendations Section -->
    <div id="recommendationsSection" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
        <div id="recommendations" class="mb-8">
            <h2 class="font-display text-2xl text-amber-800 mb-4">Anbefalte for deg</h2>
            <div id="recommendedRecipes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Recommended recipes will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Main Recipe Grid -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8 pb-12 safe-bottom">
        <h2 class="font-display text-2xl text-amber-800 mb-4">Alle Oppskrifter</h2>
        <div id="recipeGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Recipe cards will be inserted here -->
        </div>
    </div>

    <!-- Recipe Modal -->
    <div id="recipeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen sm:p-4">
            <div class="bg-white sm:rounded-2xl max-w-4xl w-full sm:h-[90vh] modal-height-mobile flex flex-col overflow-hidden modal-content-mobile">
                <div id="modalContent" class="h-full flex flex-col">
                    <!-- Recipe content will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Filter state
        let activeFilters = new Map();
        let filterMenuOpen = false;
        let searchQuery = '';
        let scrollPosition = 0;
        
        // Recipe database
        const recipeDatabase = {
            "recipe_1": {
                id: "recipe_1",
                title: "Rundstykker",
                provider: "Bestemor",
                category: "Brød",
                meal: "Frokost",
                cuisine: "Norsk",
                servings: "ca. 16 stk.",
                description: "Disse luftige rundstykkene er perfekte til søndagsfrokosten. Med en sprø skorpe og myk innmat, smaker de fantastisk med både søtt og salt pålegg. Oppskriften er enkel å følge og gir konsistente resultater hver gang.",
                ingredients: [
                    "500 g hvetemel",
                    "1 pose tørrgjær (ca. 11 g)",
                    "50 g smør (romtemperert eller smeltet)",
                    "1 ½ ts salt",
                    "2 dl melk (lunken)",
                    "1 ½ dl vann (lunkent)",
                    "1 ss sukker"
                ],
                instructions: [
                    "Bland det tørre: Ha hvetemel, tørrgjær, salt og sukker i en stor bolle.",
                    "Tilsett væske og smør: Bland melk og vann, og varm til ca. 37–40 °C (litt varmere enn fingervarmt for tørrgjær). Ha dette i melblandingen sammen med smøret.",
                    "Elt deigen: Elt i kjøkkenmaskin i 8–10 minutter, eller for hånd i 12–15 minutter, til deigen er smidig og slipper bollen.",
                    "Hev: Dekk til bollen og la deigen heve på et lunt sted i ca. 1 time, eller til den er dobbelt så stor.",
                    "Form rundstykker: Del deigen i ca. 16 emner og trill til boller. Legg dem på et stekebrett med bakepapir.",
                    "Etterhev: Dekk til og la rundstykkene etterheve i 30–40 minutter.",
                    "Stek: Forvarm ovnen til 220 °C (over- og undervarme). Stek midt i ovnen i 10–12 minutter, til de er gylne og gjennomstekte.",
                    "Avkjøl: Avkjøl på rist."
                ],
                image: "https://images.unsplash.com/photo-1509440159596-0249088772ff?w=800&h=600&fit=crop",
                createdAt: "2024-01-15"
            },
            "recipe_2": {
                id: "recipe_2",
                title: "Kanelboller",
                provider: "Sigrid",
                category: "Bakverk",
                meal: "Snacks",
                cuisine: "Skandinavisk",
                servings: "12 stk.",
                description: "Myke og saftige kanelboller med deilig smak av kanel og kardemomme. Disse bollene fyller hele huset med den herlige duften av hjemmebakst og er en sikker vinner både til kaffen og som søndagsgodt.",
                ingredients: [
                    {
                        group: "Deig",
                        items: [
                            "500 g hvetemel",
                            "1 pose tørrgjær",
                            "2 dl melk",
                            "100 g smør",
                            "1 egg",
                            "100 g sukker",
                            "1 ts kardemomme"
                        ]
                    },
                    {
                        group: "Fyll",
                        items: [
                            "75 g mykt smør",
                            "100 g sukker",
                            "2 ss kanel"
                        ]
                    },
                    {
                        group: "Pensling",
                        items: [
                            "1 egg til pensling",
                            "Perlsukker (valgfritt)"
                        ]
                    }
                ],
                instructions: [
                    "Varm melken til fingervarm og løs opp gjæren.",
                    "Bland inn egg, sukker og kardemomme.",
                    "Tilsett mel gradvis og elt til smidig deig.",
                    "La heve i 45 minutter.",
                    "Kjevle ut, smør på fyll og rull sammen.",
                    "Skjær i skiver og la etterheve i 30 minutter.",
                    "Stek ved 225°C i 8-10 minutter."
                ],
                image: "https://images.unsplash.com/photo-1609126901738-d2134918a689?w=800&h=600&fit=crop",
                createdAt: "2024-01-10"
            },
            "recipe_3": {
                id: "recipe_3",
                title: "Focaccia",
                category: "Brød",
                meal: "Tilbehør",
                cuisine: "Italiensk",
                servings: "1 langpanne",
                description: "Italiensk flatbrød med olivenolje, urter og godt krydder. Focaccia er utrolig allsidig - server den som tilbehør til supper og salater, bruk den til sandwicher, eller nyt den som den er med en god olivenolje til dypping.",
                ingredients: [
                    {
                        group: "Deig",
                        items: [
                            "500 g hvetemel",
                            "1 pose tørrgjær",
                            "3 dl vann",
                            "1 dl olivenolje",
                            "2 ts salt"
                        ]
                    },
                    {
                        group: "Topping",
                        items: [
                            "2-3 ss olivenolje til pensling",
                            "Grove havsaltflak",
                            "Frisk rosmarin",
                            "Cherrytomater (halverte)",
                            "Sorte oliven (valgfritt)",
                            "Hvitløk i skiver (valgfritt)"
                        ]
                    }
                ],
                instructions: [
                    "Bland mel, gjær og salt.",
                    "Tilsett vann og olje, elt til smidig deig.",
                    "La heve i 1 time.",
                    "Trykk deigen ut i smurt form.",
                    "Lag fordypninger med fingrene.",
                    "Drypp over olje og strø på topping.",
                    "La heve 30 minutter til.",
                    "Stek ved 220°C i 20-25 minutter."
                ],
                image: "https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=800&h=600&fit=crop",
                createdAt: "2024-02-01"
            },
            "recipe_4": {
                id: "recipe_4",
                title: "Fiskegrateng",
                provider: "Mamma",
                category: "Grateng",
                meal: "Middag",
                cuisine: "Norsk",
                servings: "4 porsjoner",
                description: "En klassisk norsk husmannskost som aldri går av moten. Denne kremete fiskegratengen med hvit saus og sprø ostelokk er både enkel å lage og smaker fantastisk. Perfekt hverdagsmiddag som hele familien vil elske.",
                ingredients: [
                    {
                        group: "Hovedingredienser",
                        items: [
                            "600 g hvit fisk (torsk eller sei)",
                            "Salt og pepper til krydring"
                        ]
                    },
                    {
                        group: "Hvit saus",
                        items: [
                            "3 ss smør",
                            "3 ss hvetemel",
                            "4 dl melk",
                            "Salt og pepper etter smak"
                        ]
                    },
                    {
                        group: "Topping",
                        items: [
                            "1 dl revet ost (gjerne Norvegia)",
                            "1 dl brødmuler"
                        ]
                    }
                ],
                instructions: [
                    "Forvarm ovnen til 200°C.",
                    "Legg fisken i en smurt ildfast form.",
                    "Smelt smør i en kjele og rør inn mel.",
                    "Tilsett melk gradvis under omrøring.",
                    "La sausen småkoke til den tykner.",
                    "Krydre med salt og pepper.",
                    "Hell sausen over fisken.",
                    "Dryss over ost og brødmuler.",
                    "Gratiner i ovnen i 25-30 minutter."
                ],
                image: "https://images.unsplash.com/photo-1519708227418-c8fd9a32b7a2?w=800&h=600&fit=crop",
                createdAt: "2024-02-10"
            },
            "recipe_5": {
                id: "recipe_5",
                title: "Sjokoladekake",
                category: "Kake",
                meal: "Dessert",
                cuisine: "Internasjonal",
                servings: "12 biter",
                description: "En dekadent og rik sjokoladekake som smelter på tungen. Med intens sjokoladesmak og en fuktig, nesten klissete konsistens, er dette den ultimate kaken for sjokoladeelskere. Server gjerne med en klatt krem eller vaniljeis.",
                ingredients: [
                    {
                        group: "Kakedeig",
                        items: [
                            "200 g mørk sjokolade",
                            "200 g smør",
                            "4 egg",
                            "250 g sukker",
                            "150 g hvetemel",
                            "1 ts bakepulver",
                            "1 ts vaniljesukker"
                        ]
                    },
                    {
                        group: "Til servering (valgfritt)",
                        items: [
                            "Melis til dryss",
                            "Friske bær",
                            "Pisket krem eller vaniljeis"
                        ]
                    }
                ],
                instructions: [
                    "Forvarm ovnen til 180°C.",
                    "Smelt sjokolade og smør sammen.",
                    "Pisk egg og sukker til eggedosis.",
                    "Bland inn sjokoladeblandingen.",
                    "Sikt inn mel og bakepulver.",
                    "Hell i kakeform.",
                    "Stek i 25-30 minutter.",
                    "Avkjøl før servering."
                ],
                image: "https://images.unsplash.com/photo-1578985545062-69928b1d9587?w=800&h=600&fit=crop",
                createdAt: "2024-02-15"
            },
            "recipe_6": {
                id: "recipe_6",
                title: "Havregrøt",
                category: "Grøt",
                meal: "Frokost",
                cuisine: "Skandinavisk",
                servings: "2 porsjoner",
                description: "Start dagen med en næringsrik og mettende havregrøt. Denne klassiske frokosten er full av fiber og gir deg energi som varer. Topp med dine favorittbær, nøtter og litt honning for ekstra smak og næring.",
                ingredients: [
                    "1 dl havregryn",
                    "2 dl melk",
                    "2 dl vann",
                    "1/2 ts salt",
                    "Topping: bær, nøtter, honning"
                ],
                instructions: [
                    "Bland havregryn, melk, vann og salt i en kjele.",
                    "Kok opp under omrøring.",
                    "La småkoke i 5 minutter.",
                    "Rør jevnlig så det ikke brenner seg.",
                    "Server med ønsket topping."
                ],
                image: "https://images.unsplash.com/photo-1517673400267-0251440c45dc?w=800&h=600&fit=crop",
                createdAt: "2024-02-20"
            },
            "recipe_7": {
                id: "recipe_7",
                title: "Lefsekling",
                provider: "Tante Kari",
                category: "Bakverk",
                meal: "Snacks",
                cuisine: "Norsk",
                servings: "20 stk.",
                description: "Tradisjonelle norske lefser som er myke, tynne og perfekte med både søtt og salt pålegg. Disse potetbaserte lommebøkene er ideelle for turmat eller som et alternativ til vanlig brød. Oppskriften har gått i arv i generasjoner.",
                ingredients: [
                    {
                        group: "Lefsedeig",
                        items: [
                            "1 kg kokte poteter (avkjølte)",
                            "500 g hvetemel",
                            "1 ts salt",
                            "1 dl melk",
                            "50 g smeltet smør"
                        ]
                    },
                    {
                        group: "Til steking",
                        items: [
                            "Hvetemel til utbaking"
                        ]
                    },
                    {
                        group: "Til servering",
                        items: [
                            "Smør",
                            "Sukker og kanel",
                            "Brunost, rømme eller syltetøy"
                        ]
                    }
                ],
                instructions: [
                    "Mos potetene godt mens de er varme.",
                    "Tilsett salt, melk og smør.",
                    "Bland inn mel til en smidig deig.",
                    "Del deigen i 20 emner.",
                    "Kjevle hver klump tynt ut.",
                    "Stek på varm takke eller stekepanne.",
                    "Legg ferdig stekte lefser mellom håndklær."
                ],
                image: "https://images.unsplash.com/photo-1555813456-94a3dd418cd3?w=800&h=600&fit=crop",
                createdAt: "2024-03-01"
            },
            "recipe_8": {
                id: "recipe_8",
                title: "Krumkake",
                category: "Kjeks",
                meal: "Dessert",
                cuisine: "Norsk",
                servings: "30 stk.",
                description: "Sprø, tynne og delikate krumkaker med hint av kardemomme. Disse tradisjonelle norske kjeksene formes mens de er varme og blir til perfekte, sprø ruller. Fyll dem med krem eller nyt dem som de er til kaffen.",
                ingredients: [
                    {
                        group: "Krumkakedeig",
                        items: [
                            "3 egg",
                            "150 g sukker",
                            "125 g smeltet smør (avkjølt)",
                            "150 g hvetemel",
                            "1 ts kardemomme",
                            "1 dl vann"
                        ]
                    },
                    {
                        group: "Fyll (valgfritt)",
                        items: [
                            "3 dl kremfløte",
                            "2 ss melis",
                            "Multesyltetøy eller jordbær"
                        ]
                    }
                ],
                instructions: [
                    "Pisk egg og sukker lett sammen.",
                    "Tilsett smeltet smør.",
                    "Bland inn mel og kardemomme.",
                    "Tilsett vann til passe konsistens.",
                    "La røren hvile i 30 minutter.",
                    "Stek i krumkakejern.",
                    "Rull raskt rundt krumkakepinne mens varm."
                ],
                image: "https://images.unsplash.com/photo-1558961363-fa8fdf82db35?w=800&h=600&fit=crop",
                createdAt: "2024-03-05"
            },
            "recipe_9": {
                id: "recipe_9",
                title: "Fårikål",
                provider: "Oldemor",
                category: "Gryte",
                meal: "Middag",
                cuisine: "Norsk",
                servings: "6 porsjoner",
                description: "Norges nasjonalrett - en enkel, men smakfull kombinasjon av lam og kål som har varmet norske hjerter i århundrer. Den langsomme koketiden gjør kjøttet utrolig mørt og kålen får en mild, søtlig smak. Perfekt høstmat!",
                ingredients: [
                    {
                        group: "Hovedingredienser",
                        items: [
                            "1,5 kg fårekjøtt i biter",
                            "1,5 kg kål (hodekål)",
                            "4 dl vann"
                        ]
                    },
                    {
                        group: "Krydder",
                        items: [
                            "2 ss salt",
                            "2 ts hel sort pepper",
                            "Hvetemel til å drysse mellom lagene"
                        ]
                    },
                    {
                        group: "Til servering",
                        items: [
                            "Kokte poteter",
                            "Flatbrød (valgfritt)"
                        ]
                    }
                ],
                instructions: [
                    "Skjær kålen i store båter.",
                    "Legg lag med kjøtt og kål i gryte.",
                    "Krydre hvert lag med salt og pepper.",
                    "Dryss litt mel mellom lagene.",
                    "Hell over vannet.",
                    "Kok opp og la småkoke i 1,5-2 timer.",
                    "Server med kokte poteter."
                ],
                image: "https://images.unsplash.com/photo-1574484284002-952d92456975?w=800&h=600&fit=crop",
                createdAt: "2024-03-10"
            }
        };

        // User data - automatically saved to localStorage
        let userData = {};

        // Load user data from localStorage
        function loadData() {
            const storedUserData = localStorage.getItem('userData');
            if (storedUserData) {
                userData = JSON.parse(storedUserData);
            }
        }

        // Save user data to localStorage
        function saveData() {
            localStorage.setItem('userData', JSON.stringify(userData));
        }

        // Get recipe with user data merged
        function getRecipeWithUserData(recipeId) {
            const recipe = recipeDatabase[recipeId];
            const userInfo = userData[recipeId] || {
                userRating: null,
                madeDates: [],
                lastViewed: null,
                favorite: false
            };
            return { ...recipe, ...userInfo };
        }

        // Initialize user data for new recipe
        function initializeUserData(recipeId) {
            if (!userData[recipeId]) {
                userData[recipeId] = {
                    userRating: null,
                    madeDates: [],
                    lastViewed: null,
                    viewCount: 0,
                    favorite: false
                };
            }
        }

        // Get unique categories, meals and cuisines from recipes
        function getRecipeFilters() {
            const categories = new Set();
            const meals = new Set();
            const cuisines = new Set();
            
            Object.values(recipeDatabase).forEach(recipe => {
                if (recipe.category) categories.add(recipe.category);
                if (recipe.meal) meals.add(recipe.meal);
                if (recipe.cuisine) cuisines.add(recipe.cuisine);
            });
            
            return {
                categories: Array.from(categories).sort(),
                meals: Array.from(meals).sort(),
                cuisines: Array.from(cuisines).sort()
            };
        }

        // Activate filter by clicking on category/meal/cuisine
        function activateFilter(filterType, filterValue, event) {
            if (event) {
                event.stopPropagation();
            }
            
            const filterKey = `${filterType}:${filterValue}`;
            
            // Close modal if it's open
            const modal = document.getElementById('recipeModal');
            if (!modal.classList.contains('hidden')) {
                closeRecipe();
            }
            
            // Add filter if not already active
            if (!activeFilters.has(filterKey)) {
                activeFilters.set(filterKey, true);
                renderFilterPills();
                updateFilterButton();
                applyFilters();
                renderFilterOptions();
                updateRecommendationsVisibility();
            }
        }

        // Render filter options in dropdown
        function renderFilterOptions() {
            const container = document.getElementById('filterOptions');
            const filters = getRecipeFilters();
            
            container.innerHTML = '';
            
            // Category filters
            if (filters.categories.length > 0) {
                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'text-xs font-semibold text-gray-500 uppercase tracking-wider px-2 pt-1 pb-1';
                categoryHeader.textContent = 'Kategori';
                container.appendChild(categoryHeader);
                
                filters.categories.forEach(category => {
                    const isSelected = activeFilters.has(`category:${category}`);
                    const option = document.createElement('label');
                    option.className = 'flex items-center justify-between p-2 hover:bg-amber-50 rounded-lg cursor-pointer transition-colors';
                    option.innerHTML = `
                        <span class="text-sm text-gray-700">${category}</span>
                        <input type="checkbox" 
                               ${isSelected ? 'checked' : ''} 
                               onchange="toggleFilterType('category:${category}')"
                               onclick="event.stopPropagation()"
                               class="rounded border-gray-300 text-amber-600 focus:ring-amber-500 cursor-pointer">
                    `;
                    container.appendChild(option);
                });
            }
            
            // Meal filters
            if (filters.meals.length > 0) {
                const mealHeader = document.createElement('div');
                mealHeader.className = 'text-xs font-semibold text-gray-500 uppercase tracking-wider px-2 pt-3 pb-1';
                mealHeader.textContent = 'Måltid';
                container.appendChild(mealHeader);
                
                filters.meals.forEach(meal => {
                    const isSelected = activeFilters.has(`meal:${meal}`);
                    const option = document.createElement('label');
                    option.className = 'flex items-center justify-between p-2 hover:bg-amber-50 rounded-lg cursor-pointer transition-colors';
                    option.innerHTML = `
                        <span class="text-sm text-gray-700">${meal}</span>
                        <input type="checkbox" 
                               ${isSelected ? 'checked' : ''} 
                               onchange="toggleFilterType('meal:${meal}')"
                               onclick="event.stopPropagation()"
                               class="rounded border-gray-300 text-amber-600 focus:ring-amber-500 cursor-pointer">
                    `;
                    container.appendChild(option);
                });
            }
            
            // Cuisine filters
            if (filters.cuisines.length > 0) {
                const cuisineHeader = document.createElement('div');
                cuisineHeader.className = 'text-xs font-semibold text-gray-500 uppercase tracking-wider px-2 pt-3 pb-1';
                cuisineHeader.textContent = 'Kjøkken';
                container.appendChild(cuisineHeader);
                
                filters.cuisines.forEach(cuisine => {
                    const isSelected = activeFilters.has(`cuisine:${cuisine}`);
                    const option = document.createElement('label');
                    option.className = 'flex items-center justify-between p-2 hover:bg-amber-50 rounded-lg cursor-pointer transition-colors';
                    option.innerHTML = `
                        <span class="text-sm text-gray-700">${cuisine}</span>
                        <input type="checkbox" 
                               ${isSelected ? 'checked' : ''} 
                               onchange="toggleFilterType('cuisine:${cuisine}')"
                               onclick="event.stopPropagation()"
                               class="rounded border-gray-300 text-amber-600 focus:ring-amber-500 cursor-pointer">
                    `;
                    container.appendChild(option);
                });
            }
        }

        // Check if search or filters are active
        function hasActiveSearchOrFilters() {
            return searchQuery.length > 0 || activeFilters.size > 0;
        }

        // Update recommendations visibility
        function updateRecommendationsVisibility() {
            const recommendationsSection = document.getElementById('recommendationsSection');
            if (hasActiveSearchOrFilters()) {
                recommendationsSection.style.display = 'none';
            } else {
                recommendationsSection.style.display = 'block';
            }
        }

        // Toggle filter type selection
        function toggleFilterType(type) {
            if (activeFilters.has(type)) {
                activeFilters.delete(type);
            } else {
                activeFilters.set(type, true);
            }
            renderFilterPills();
            updateFilterButton();
            applyFilters();
            renderFilterOptions();
            updateRecommendationsVisibility();
        }

        // Render filter pills
        function renderFilterPills() {
            const container = document.getElementById('filterPillsContainer');
            const hasFilters = activeFilters.size > 0;
            
            container.innerHTML = '';
            container.style.maxWidth = hasFilters ? '100%' : '0';
            container.style.opacity = hasFilters ? '1' : '0';
            
            activeFilters.forEach((isActive, filterKey) => {
                const [filterType, filterValue] = filterKey.split(':');
                const displayName = filterValue || filterKey;
                
                const pill = document.createElement('div');
                pill.className = `flex items-center gap-1 px-3 py-1.5 rounded-full text-sm transition-all shadow-sm ${
                    isActive 
                        ? 'bg-gradient-to-r from-amber-500 to-amber-600 text-white' 
                        : 'bg-gray-200 text-gray-500 opacity-60'
                }`;
                pill.innerHTML = `
                    <span class="cursor-pointer font-medium" onclick="togglePillActive('${filterKey}')">${displayName}</span>
                    <button onclick="removeFilter('${filterKey}')" class="ml-1 hover:opacity-70">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                `;
                container.appendChild(pill);
            });
            
            // Update clear button visibility
            const clearBtn = document.getElementById('clearFilters');
            if (hasFilters) {
                clearBtn.classList.remove('opacity-0', 'pointer-events-none');
                clearBtn.classList.add('opacity-100');
            } else {
                clearBtn.classList.add('opacity-0', 'pointer-events-none');
                clearBtn.classList.remove('opacity-100');
            }
        }

        // Toggle pill active/inactive state
        function togglePillActive(type) {
            if (activeFilters.has(type)) {
                activeFilters.set(type, !activeFilters.get(type));
                renderFilterPills();
                applyFilters();
            }
        }

        // Remove filter
        function removeFilter(type) {
            activeFilters.delete(type);
            renderFilterPills();
            updateFilterButton();
            applyFilters();
            renderFilterOptions();
            updateRecommendationsVisibility();
        }

        // Update filter button state
        function updateFilterButton() {
            const btn = document.getElementById('filterToggle');
            const count = document.getElementById('filterCount');
            const hasFilters = activeFilters.size > 0;
            
            btn.className = 'flex items-center space-x-2 px-4 py-2 rounded-xl transition-all text-sm font-medium shrink-0 shadow-sm hover:shadow-md';
            
            if (hasFilters) {
                btn.classList.add('bg-gradient-to-r', 'from-amber-500', 'to-amber-600', 'text-white', 'hover:from-amber-600', 'hover:to-amber-700');
                count.textContent = activeFilters.size;
                count.classList.remove('hidden');
                count.classList.add('bg-white/30');
            } else {
                btn.classList.add('bg-white', 'text-gray-700', 'hover:text-amber-600', 'border', 'border-gray-200');
                count.classList.add('hidden');
            }
        }

        // Toggle filter menu
        function toggleFilterMenu() {
            const menu = document.querySelector('#filterMenu > div');
            
            if (!filterMenuOpen) {
                renderFilterOptions();
                menu.classList.remove('hidden');
                filterMenuOpen = true;
            } else {
                menu.classList.add('hidden');
                filterMenuOpen = false;
            }
        }

        // Clear all filters
        function clearAllFilters() {
            activeFilters.clear();
            renderFilterPills();
            updateFilterButton();
            applyFilters();
            renderFilterOptions();
            updateRecommendationsVisibility();
        }

        // Apply both search and type filters
        function applyFilters() {
            let filtered = Object.keys(recipeDatabase);
            
            // Apply filters
            const activeCategoryFilters = [];
            const activeMealFilters = [];
            const activeCuisineFilters = [];
            
            activeFilters.forEach((isActive, filterKey) => {
                if (!isActive) return;
                
                const [filterType, filterValue] = filterKey.split(':');
                if (filterType === 'category') {
                    activeCategoryFilters.push(filterValue);
                } else if (filterType === 'meal') {
                    activeMealFilters.push(filterValue);
                } else if (filterType === 'cuisine') {
                    activeCuisineFilters.push(filterValue);
                }
            });
            
            // Filter by category
            if (activeCategoryFilters.length > 0) {
                filtered = filtered.filter(id => 
                    activeCategoryFilters.includes(recipeDatabase[id].category)
                );
            }
            
            // Filter by meal type
            if (activeMealFilters.length > 0) {
                filtered = filtered.filter(id => 
                    activeMealFilters.includes(recipeDatabase[id].meal)
                );
            }
            
            // Filter by cuisine type
            if (activeCuisineFilters.length > 0) {
                filtered = filtered.filter(id => 
                    activeCuisineFilters.includes(recipeDatabase[id].cuisine)
                );
            }
            
            // Apply search filter
            if (searchQuery) {
                filtered = filtered.filter(id => {
                    const recipe = recipeDatabase[id];
                    const titleMatch = recipe.title.toLowerCase().includes(searchQuery);
                    
                    // Handle both grouped and non-grouped ingredient formats
                    let ingredientMatch = false;
                    if (recipe.ingredients) {
                        recipe.ingredients.forEach(item => {
                            if (typeof item === 'string') {
                                if (item.toLowerCase().includes(searchQuery)) {
                                    ingredientMatch = true;
                                }
                            } else if (item.items) {
                                item.items.forEach(ing => {
                                    if (ing.toLowerCase().includes(searchQuery)) {
                                        ingredientMatch = true;
                                    }
                                });
                            }
                        });
                    }
                    
                    return titleMatch || ingredientMatch;
                });
            }
            
            renderRecipes(filtered);
        }

        // Close filter menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('filterMenu');
            const toggle = document.getElementById('filterToggle');
            
            if (filterMenuOpen && 
                !menu.contains(e.target) && 
                !toggle.contains(e.target)) {
                toggleFilterMenu();
            }
        });

        // Render recipes
        function renderRecipes(recipesToRender = null) {
            const grid = document.getElementById('recipeGrid');
            grid.innerHTML = '';
            
            const recipeIds = recipesToRender || Object.keys(recipeDatabase);
            
            recipeIds.forEach(recipeId => {
                const recipeData = getRecipeWithUserData(recipeId);
                const card = createRecipeCard(recipeData);
                grid.appendChild(card);
            });
        }

        // Create recipe card
        function createRecipeCard(recipe) {
            const card = document.createElement('div');
            card.className = 'recipe-card bg-white rounded-xl shadow-md overflow-hidden cursor-pointer hover:shadow-xl';
            card.setAttribute('data-recipe-id', recipe.id);
            card.onclick = () => showRecipe(recipe.id);
            
            const imageUrl = recipe.image || `https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=800&h=600&fit=crop`;
            
            card.innerHTML = `
                <div class="h-48 bg-gradient-to-br from-amber-100 to-orange-100 relative overflow-hidden">
                    ${recipe.image ? `<img src="${imageUrl}" alt="${recipe.title}" class="w-full h-full object-cover">` : 
                    `<div class="w-full h-full flex items-center justify-center">
                        <span class="text-6xl opacity-30">🍞</span>
                    </div>`}
                    ${recipe.category ? `<span onclick="activateFilter('category', '${recipe.category}', event)" class="category-badge absolute top-2 right-2 bg-white/90 backdrop-blur text-xs font-medium px-2 py-1 rounded-full text-amber-700">${recipe.category}</span>` : ''}
                </div>
                <div class="p-5">
                    <h3 class="font-display text-xl text-gray-800 ${recipe.provider ? 'mb-0' : 'mb-2'}">${recipe.title}</h3>
                    ${recipe.provider ? `<p class="text-xs text-amber-600 mb-2">${recipe.provider}s oppskrift</p>` : ''}
                    <p class="text-gray-600 text-sm mb-3">${recipe.servings}</p>
                    <div class="flex items-center justify-between">
                        <div class="recipe-stars flex items-center space-x-1">
                            ${renderStars(recipe.userRating || 0)}
                        </div>
                        <div class="flex items-center text-sm text-gray-600">
                            <span class="mr-1">👨‍🍳</span>
                            <span class="recipe-counter">${recipe.madeDates ? recipe.madeDates.length : 0}</span>
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }

        // Render ingredients (handles both grouped and non-grouped formats)
        function renderIngredients(ingredients) {
            if (!ingredients || ingredients.length === 0) return '';
            
            // Check if ingredients are grouped
            const hasGroups = ingredients.some(item => typeof item === 'object' && item.group);
            
            if (!hasGroups) {
                // Simple list format
                return `
                    <ul class="space-y-2">
                        ${ingredients.map(ing => `
                            <li class="flex items-start">
                                <span class="text-amber-600 mr-2">•</span>
                                <span class="text-gray-700">${ing}</span>
                            </li>
                        `).join('')}
                    </ul>
                `;
            } else {
                // Grouped format
                return ingredients.map((group, index) => {
                    if (typeof group === 'string') {
                        return `
                            <ul class="space-y-2 ${index > 0 ? 'mt-4' : ''}">
                                <li class="flex items-start">
                                    <span class="text-amber-600 mr-2">•</span>
                                    <span class="text-gray-700">${group}</span>
                                </li>
                            </ul>
                        `;
                    }
                    
                    return `
                        <div class="${index > 0 ? 'mt-5' : ''}">
                            <h4 class="font-semibold text-sm text-amber-700 mb-2">${group.group}:</h4>
                            <ul class="space-y-2">
                                ${group.items.map(ing => `
                                    <li class="flex items-start">
                                        <span class="text-amber-600 mr-2">•</span>
                                        <span class="text-gray-700">${ing}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                }).join('');
            }
        }

        // Render star rating
        function renderStars(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += '<span class="text-amber-400">★</span>';
                } else {
                    stars += '<span class="text-gray-300">★</span>';
                }
            }
            return stars;
        }

        // Check if device is mobile
        function isMobile() {
            return window.innerWidth <= 640;
        }

        // Show recipe modal
        function showRecipe(recipeId) {
            const recipe = getRecipeWithUserData(recipeId);
            if (!recipe) return;
            
            // Update view tracking
            if (!userData[recipeId]) {
                initializeUserData(recipeId);
            }
            userData[recipeId].lastViewed = new Date().toISOString();
            userData[recipeId].viewCount = (userData[recipeId].viewCount || 0) + 1;
            saveData();
            
            const modal = document.getElementById('recipeModal');
            const content = document.getElementById('modalContent');
            
            const imageUrl = recipe.image || `https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=800&h=600&fit=crop`;
            
            // Check if recipe was made today
            const today = new Date().toISOString().split('T')[0];
            const madeToday = recipe.madeDates && recipe.madeDates.includes(today);
            const madeCount = recipe.madeDates ? recipe.madeDates.length : 0;
            
            // Mobile-specific layout
            if (isMobile()) {
                content.innerHTML = `
                    <div class="relative flex flex-col h-full overflow-y-auto modal-scroll-mobile">
                        <button onclick="closeRecipe()" class="modal-close-mobile bg-white/90 backdrop-blur rounded-full p-2 hover:bg-white shadow-lg">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                        <div class="h-56 bg-gradient-to-br from-amber-100 to-orange-100 relative flex-shrink-0">
                            ${recipe.image ? `<img src="${imageUrl}" alt="${recipe.title}" class="w-full h-full object-cover">` : 
                            `<div class="w-full h-full flex items-center justify-center">
                                <span class="text-8xl opacity-30">🍞</span>
                            </div>`}
                            ${recipe.category ? `<span onclick="activateFilter('category', '${recipe.category}', event)" class="category-badge absolute top-4 left-4 bg-white/90 backdrop-blur text-xs font-medium px-2 py-1 rounded-full text-amber-700">${recipe.category}</span>` : ''}
                        </div>
                        <div class="flex-1 px-4 pb-12 bg-white">
                            <div class="pt-4 pb-3">
                                <h2 class="font-display text-2xl text-gray-800 ${recipe.provider ? 'mb-0' : 'mb-1'}">${recipe.title}</h2>
                                ${recipe.provider ? `<p class="text-xs text-amber-600 mb-2">${recipe.provider}s oppskrift</p>` : ''}
                                <p class="text-gray-600 text-sm mb-3">${recipe.servings}</p>
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center">
                                        ${renderInteractiveStars(recipe)}
                                    </div>
                                    <button onclick="toggleMadeToday('${recipe.id}', event)" 
                                            class="flex items-center space-x-1 px-3 py-1.5 rounded-lg transition text-xs font-medium
                                                   ${madeToday 
                                                     ? 'bg-amber-600 text-white' 
                                                     : 'border border-gray-300 text-gray-600 hover:bg-gray-50'}">
                                        <svg class="w-4 h-4" fill="${madeToday ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        <span>Laget (${madeCount})</span>
                                    </button>
                                </div>
                                ${recipe.cuisine || recipe.meal ? `
                                <div class="text-xs text-gray-500">
                                    ${recipe.cuisine ? `<span onclick="activateFilter('cuisine', '${recipe.cuisine}', event)" class="category-badge inline-block px-2 py-0.5 bg-gray-100 rounded-full cursor-pointer hover:bg-amber-100">${recipe.cuisine} kjøkken</span>` : ''}
                                    ${recipe.cuisine && recipe.meal ? ' ' : ''}
                                    ${recipe.meal ? `<span onclick="activateFilter('meal', '${recipe.meal}', event)" class="category-badge inline-block px-2 py-0.5 bg-gray-100 rounded-full cursor-pointer hover:bg-amber-100">${recipe.meal}</span>` : ''}
                                </div>
                                ` : ''}
                            </div>
                            
                            ${recipe.description ? `
                            <div class="pb-4">
                                <p class="text-gray-700 text-sm leading-relaxed">${recipe.description}</p>
                            </div>
                            ` : ''}
                            
                            <div class="space-y-6">
                                <div>
                                    <h3 class="font-display text-xl text-amber-800 mb-3">Ingredienser</h3>
                                    ${renderIngredients(recipe.ingredients)}
                                </div>
                                
                                <div>
                                    <h3 class="font-display text-xl text-amber-800 mb-3">Fremgangsmåte</h3>
                                    <ol class="space-y-3">
                                        ${recipe.instructions.map((inst, i) => `
                                            <li class="flex items-start">
                                                <span class="font-semibold text-amber-600 mr-3 flex-shrink-0">${i + 1}.</span>
                                                <span class="text-gray-700 text-sm">${inst}</span>
                                            </li>
                                        `).join('')}
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Desktop layout
                content.innerHTML = `
                    <div class="relative flex flex-col h-full">
                        <button onclick="closeRecipe()" class="absolute top-4 right-4 bg-white/90 backdrop-blur rounded-full p-2 hover:bg-white z-10 shadow-lg">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                        <div class="h-56 bg-gradient-to-br from-amber-100 to-orange-100 relative flex-shrink-0">
                            ${recipe.image ? `<img src="${imageUrl}" alt="${recipe.title}" class="w-full h-full object-cover">` : 
                            `<div class="w-full h-full flex items-center justify-center">
                                <span class="text-8xl opacity-30">🍞</span>
                            </div>`}
                            ${recipe.category ? `<span onclick="activateFilter('category', '${recipe.category}', event)" class="category-badge absolute top-4 left-6 bg-white/90 backdrop-blur text-xs font-medium px-2 py-1 rounded-full text-amber-700">${recipe.category}</span>` : ''}
                        </div>
                        <div class="flex-1 flex flex-col overflow-hidden bg-white">
                            <div class="px-6 pt-5 pb-4 flex-shrink-0 border-b border-gray-100">
                                <h2 class="font-display text-3xl text-gray-800 ${recipe.provider ? 'mb-0' : 'mb-1'}">${recipe.title}</h2>
                                ${recipe.provider ? `<p class="text-xs text-amber-600 mb-2">${recipe.provider}s oppskrift</p>` : ''}
                                <p class="text-gray-600 text-sm mb-3">${recipe.servings}</p>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-4">
                                        <div class="flex items-center">
                                            ${renderInteractiveStars(recipe)}
                                        </div>
                                        ${recipe.cuisine || recipe.meal ? `
                                        <div class="text-sm text-gray-500">
                                            ${recipe.cuisine ? `<span onclick="activateFilter('cuisine', '${recipe.cuisine}', event)" class="category-badge inline-block px-2 py-0.5 bg-gray-100 rounded-full cursor-pointer hover:bg-amber-100">${recipe.cuisine} kjøkken</span>` : ''}
                                            ${recipe.cuisine && recipe.meal ? ' ' : ''}
                                            ${recipe.meal ? `<span onclick="activateFilter('meal', '${recipe.meal}', event)" class="category-badge inline-block px-2 py-0.5 bg-gray-100 rounded-full cursor-pointer hover:bg-amber-100">${recipe.meal}</span>` : ''}
                                        </div>
                                        ` : ''}
                                    </div>
                                    <button onclick="toggleMadeToday('${recipe.id}', event)" 
                                            class="flex items-center space-x-2 px-3 py-1.5 rounded-lg transition text-sm font-medium
                                                   ${madeToday 
                                                     ? 'bg-amber-600 text-white hover:bg-amber-700' 
                                                     : 'border border-gray-300 text-gray-600 hover:bg-gray-50'}">
                                        <svg class="w-5 h-5" fill="${madeToday ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        <span>Laget (${madeCount})</span>
                                    </button>
                                </div>
                            </div>
                            
                            ${recipe.description ? `
                            <div class="px-6 py-4 flex-shrink-0 bg-amber-50/30">
                                <p class="text-gray-700 leading-relaxed">${recipe.description}</p>
                            </div>
                            ` : ''}
                            
                            <div class="grid md:grid-cols-2 gap-6 px-6 py-6 flex-1 overflow-hidden">
                                <div class="flex flex-col">
                                    <h3 class="font-display text-xl text-amber-800 mb-3 flex-shrink-0">Ingredienser</h3>
                                    <div class="overflow-y-auto pr-2 pb-8 recipe-scroll" style="max-height: calc(100vh - ${recipe.description ? '580' : '480'}px);">
                                        ${renderIngredients(recipe.ingredients)}
                                    </div>
                                </div>
                                
                                <div class="flex flex-col">
                                    <h3 class="font-display text-xl text-amber-800 mb-3 flex-shrink-0">Fremgangsmåte</h3>
                                    <div class="overflow-y-auto pr-2 pb-8 recipe-scroll" style="max-height: calc(100vh - ${recipe.description ? '580' : '480'}px);">
                                        <ol class="space-y-3">
                                            ${recipe.instructions.map((inst, i) => `
                                                <li class="flex items-start">
                                                    <span class="font-semibold text-amber-600 mr-3 flex-shrink-0">${i + 1}.</span>
                                                    <span class="text-gray-700">${inst}</span>
                                                </li>
                                            `).join('')}
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Lock body scroll
            scrollPosition = window.pageYOffset;
            document.body.classList.add('modal-open');
            document.body.style.top = `-${scrollPosition}px`;
            modal.classList.remove('hidden');
        }

        // Render interactive stars for rating
        function renderInteractiveStars(recipe) {
            let stars = '';
            const userRating = recipe.userRating || 0;
            for (let i = 1; i <= 5; i++) {
                const filled = i <= userRating;
                stars += `<button onclick="rateRecipe('${recipe.id}', ${i}, event)" class="star text-2xl ${filled ? 'text-amber-400' : 'text-gray-300'} hover:text-amber-500">★</button>`;
            }
            return stars;
        }

        // Close recipe modal
        function closeRecipe() {
            document.getElementById('recipeModal').classList.add('hidden');
            // Restore body scroll
            document.body.classList.remove('modal-open');
            document.body.style.top = '';
            window.scrollTo(0, scrollPosition);
        }

        // Rate recipe
        function rateRecipe(recipeId, rating, event) {
            if (event) {
                event.stopPropagation();
            }
            
            if (!userData[recipeId]) {
                initializeUserData(recipeId);
            }
            
            userData[recipeId].userRating = rating;
            saveData();
            
            // Update stars without rebuilding modal
            const button = event ? event.currentTarget : null;
            if (button && button.parentElement) {
                const starsContainer = button.parentElement;
                const stars = starsContainer.querySelectorAll('button');
                stars.forEach((star, index) => {
                    if (index < rating) {
                        star.classList.remove('text-gray-300');
                        star.classList.add('text-amber-400');
                    } else {
                        star.classList.remove('text-amber-400');
                        star.classList.add('text-gray-300');
                    }
                });
            }
            
            // Update the rating in the grid cards
            updateRecipeCardRating(recipeId, rating);
            
            // Refresh recommendations after rating
            setTimeout(() => getRecommendations(), 100);
        }
        
        // Update recipe card rating in the grid
        function updateRecipeCardRating(recipeId, rating) {
            const cards = document.querySelectorAll(`[data-recipe-id="${recipeId}"]`);
            cards.forEach(card => {
                const starsContainer = card.querySelector('.recipe-stars');
                if (starsContainer) {
                    starsContainer.innerHTML = renderStars(rating);
                }
            });
        }

        // Toggle made today
        function toggleMadeToday(recipeId, event) {
            if (event) {
                event.stopPropagation();
            }
            
            if (!userData[recipeId]) {
                initializeUserData(recipeId);
            }
            
            const today = new Date().toISOString().split('T')[0];
            const madeDates = userData[recipeId].madeDates || [];
            
            const todayIndex = madeDates.indexOf(today);
            if (todayIndex > -1) {
                madeDates.splice(todayIndex, 1);
            } else {
                madeDates.push(today);
            }
            
            userData[recipeId].madeDates = madeDates;
            saveData();
            
            // Update button appearance without rebuilding modal
            const madeToday = madeDates.includes(today);
            const madeCount = madeDates.length;
            const button = event ? event.currentTarget : document.querySelector(`button[onclick*="toggleMadeToday('${recipeId}'"]`);
            
            if (button) {
                // Update button classes
                if (isMobile()) {
                    button.className = `flex items-center space-x-1 px-3 py-1.5 rounded-lg transition text-xs font-medium ${
                        madeToday 
                            ? 'bg-amber-600 text-white' 
                            : 'border border-gray-300 text-gray-600 hover:bg-gray-50'
                    }`;
                } else {
                    button.className = `flex items-center space-x-2 px-3 py-1.5 rounded-lg transition text-sm font-medium ${
                        madeToday 
                            ? 'bg-amber-600 text-white hover:bg-amber-700' 
                            : 'border border-gray-300 text-gray-600 hover:bg-gray-50'
                    }`;
                }
                
                // Update button content
                button.innerHTML = `
                    <svg class="${isMobile() ? 'w-4 h-4' : 'w-5 h-5'}" fill="${madeToday ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span>Laget (${madeCount})</span>
                `;
            }
            
            // Update the cooked counter in the grid
            updateRecipeCardCounter(recipeId, madeCount);
            
            // Refresh recommendations
            setTimeout(() => getRecommendations(), 100);
        }
        
        // Update recipe card counter in the grid
        function updateRecipeCardCounter(recipeId, count) {
            const cards = document.querySelectorAll(`[data-recipe-id="${recipeId}"]`);
            cards.forEach(card => {
                const counterElement = card.querySelector('.recipe-counter');
                if (counterElement) {
                    counterElement.textContent = count;
                }
            });
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
            searchQuery = e.target.value.toLowerCase();
            applyFilters();
            updateRecommendationsVisibility();
        });

        // Get recommendations
        function getRecommendations() {
            const recommended = document.getElementById('recommendedRecipes');
            
            let recs = [];
            const recipeIds = Object.keys(recipeDatabase);
            
            const threeDaysAgo = new Date();
            threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
            
            // Recently viewed but not in the last 3 days
            const oldViewed = recipeIds.filter(id => {
                const lastViewed = userData[id]?.lastViewed;
                if (!lastViewed) return false;
                const viewedDate = new Date(lastViewed);
                return viewedDate < threeDaysAgo;
            }).slice(0, 2);
            
            // Never viewed
            const neverViewed = recipeIds.filter(id => !userData[id]?.lastViewed).slice(0, 2);
            
            // Highly rated
            const highRated = recipeIds
                .filter(id => (userData[id]?.userRating || 0) > 3)
                .sort((a, b) => (userData[b]?.userRating || 0) - (userData[a]?.userRating || 0))
                .slice(0, 2);
            
            // Combine recommendations (unique)
            const recIdSet = new Set();
            [...oldViewed, ...neverViewed, ...highRated].forEach(id => {
                if (!recIdSet.has(id) && recs.length < 3) {
                    recIdSet.add(id);
                    recs.push(id);
                }
            });
            
            // If we don't have 3 recommendations, add random ones
            while (recs.length < 3 && recs.length < recipeIds.length) {
                const randomId = recipeIds[Math.floor(Math.random() * recipeIds.length)];
                if (!recIdSet.has(randomId)) {
                    recIdSet.add(randomId);
                    recs.push(randomId);
                }
            }
            
            recommended.innerHTML = '';
            recs.forEach(recipeId => {
                const recipeData = getRecipeWithUserData(recipeId);
                const card = createRecipeCard(recipeData);
                recommended.appendChild(card);
            });
        }

        // Close modal on outside click
        document.getElementById('recipeModal').addEventListener('click', (e) => {
            const modalContent = document.querySelector('#recipeModal > div > div');
            if (!modalContent.contains(e.target)) {
                closeRecipe();
            }
        });

        // Initialize
        loadData();
        updateFilterButton();
        renderRecipes();
        getRecommendations();
        updateRecommendationsVisibility();
    </script>
</body>
</html>
